var VERSION="1.4.3",AlertAction=class{title;handler;constructor({title:t=$l10n("OK"),disabled:e=!1,style:i=$alertActionType.default,handler:s=()=>{}}={}){this.title=t,this.disabled=e,this.style=i,this.handler=s}},Alert=class r{id=$text.uuid;title;message;actions;titleFont=$font("bold",20);messageFont=$font(14);actionButtonFontSize=16;actionButtonHighlight=$color($rgba(0,0,0,.2),$rgba(255,255,255,.2));actionButtonHeight=35;actionButtonBoderWidth=.5;actionButtonBorderColor=$color("#C9C9C9","#383838");boxWidth=250;textVerticalMargin=20;textHorizontalMargin=50;constructor({title:t="",message:e="",actions:i=[]}={}){this.title=t,this.message=e,this.actions=i,this.actions.length===0&&this.actions.push(new AlertAction),this.titleSize=UIKit.getContentSize(this.titleFont,this.title,this.boxWidth-this.textHorizontalMargin*2),this.messageSize=UIKit.getContentSize(this.messageFont,this.message,this.boxWidth-this.textHorizontalMargin*2)}textView(){return{type:"view",views:[{type:"label",props:{lines:0,font:this.titleFont,text:this.title,color:$color("tint"),align:$align.center},layout:(t,e)=>{t.centerX.equalTo(e.super),t.width.equalTo(this.boxWidth-this.textHorizontalMargin*2),t.height.equalTo(this.titleSize.height),t.top.equalTo(this.textVerticalMargin)}},{type:"label",props:{lines:0,font:this.messageFont,text:this.message,align:$align.center},layout:(t,e)=>{t.centerX.equalTo(e.super),t.width.equalTo(this.boxWidth-this.textHorizontalMargin*2),t.height.equalTo(this.messageSize.height),t.top.equalTo(e.prev.bottom)}}],layout:(t,e)=>{t.top.width.equalTo(e.super),t.height.equalTo(this.titleSize.height+this.messageSize.height+this.textVerticalMargin*2)}}}actionView(){let t=(e,i)=>{let s=l=>this.actions.length===2?l.y>=0&&l.x>=0&&l.y<=this.actionButtonHeight&&l.x<=this.boxWidth/2:l.y>=0&&l.x>=0&&l.y<=this.actionButtonHeight&&l.x<=this.boxWidth,o=async(l,h,u)=>{e.disabled||(l.bgcolor=$color("clear"),s(h)&&(typeof e.handler=="function"&&await e.handler({index:i,title:e.title}),this.dismiss()))},a=$color("tint"),n=$font(this.actionButtonFontSize);return e.disabled?a=$color("gray"):e.style===$alertActionType.destructive?a=$color("red"):e.style===$alertActionType.cancel&&(n=$font("bold",this.actionButtonFontSize)),{type:"label",props:{lines:1,text:e.title,align:$align.center,font:n,color:a,borderWidth:this.actionButtonBoderWidth,borderColor:this.actionButtonBorderColor,bgcolor:$color("clear")},events:{tapped:()=>{},touchesBegan:l=>{e.disabled||(l.bgcolor=this.actionButtonHighlight)},touchesEnded:o,touchesCancelled:o,touchesMoved:(l,h,u)=>{e.disabled||(s(h)?l.bgcolor=this.actionButtonHighlight:l.bgcolor=$color("clear"))}},layout:(l,h)=>{this.actions.length===2?h.prev?(l.left.equalTo(h.prev.right).offset(-this.actionButtonBoderWidth),l.width.equalTo(h.super).dividedBy(2).offset(this.actionButtonBoderWidth)):l.width.equalTo(h.super).dividedBy(2):(l.width.equalTo(h.super),h.prev&&l.top.equalTo(h.prev.bottom).offset(-this.actionButtonBoderWidth)),l.height.equalTo(this.actionButtonHeight)}}};return{type:"view",views:this.actions.map((e,i)=>t(e,i)),layout:(e,i)=>{e.left.equalTo(i.super).offset(-this.actionButtonBoderWidth),e.width.equalTo(i.super).offset(this.actionButtonBoderWidth*2),e.bottom.equalTo(i.super),e.top.equalTo(i.prev.bottom)}}}getView(){let t={type:"view",props:{id:this.id+"-box",smoothCorners:!0,cornerRadius:20,bgcolor:$color("#FFFFFF","#000000")},views:[this.textView(),this.actionView()],layout:(e,i)=>{e.center.equalTo(i.super.safeArea);let s=this.titleSize.height+this.messageSize.height+this.textVerticalMargin*2,o=this.actions.length>2?this.actions.length:1;s+=this.actionButtonHeight*o,s-=this.actionButtonBoderWidth*o;let a=this.boxWidth-this.actionButtonBoderWidth*2;e.size.equalTo($size(a,s))}};return{type:"view",props:{id:this.id,alpha:0,bgcolor:$rgba(0,0,0,.6)},views:[t],layout:$layout.fill}}present(){let t=$ui.create(this.getView());$ui.controller.view.hidden?$ui.controller.view.super.insertAtIndex(t,0):$ui.controller.view.insertAtIndex(t,0);let e=$(this.id);e.layout($layout.fill),e.moveToFront(),$ui.animate({duration:.3,animation:()=>{e.alpha=1}})}dismiss(){let t=$(this.id);$ui.animate({duration:.3,animation:()=>{t.alpha=0},completion:()=>{t.remove()}})}static fromJsbox(t){return new Promise((e,i)=>{new r({title:t.title,message:t.message,actions:t?.actions?.map(o=>(o.handler||(o.handler=a=>{e(a)}),new AlertAction(o)))}).present()})}},Controller=class{events={};setEvents(t){return Object.keys(t).forEach(e=>this.setEvent(e,t[e])),this}setEvent(t,e){return this.events[t]=e,this}appendEvent(t,e){let i=this.events[t];return typeof i=="function"?this.events[t]=(...s)=>{i(...s),e(...s)}:this.setEvent(t,e),this}callEvent(t,...e){typeof this.events[t]=="function"&&this.events[t](...e)}},FileManager=class{viewController;constructor(){this.listId="file-manager-list",this.edges=10,this.iconSize=25}setViewController(t){this.viewController=t}get menu(){return{items:[{title:$l10n("SHARE"),symbol:"square.and.arrow.up",handler:async(t,e)=>{let i=t.object(e).info.info;$share.sheet([$file.absolutePath(i.path)])}}]}}delete(t){$file.delete(t.path)}edit(t){let e=$file.read(t.path);if(e.info?.mimeType?.startsWith("image"))Sheet.quickLookImage(e,t.path.substring(t.path.lastIndexOf("/")+1));else{let i=new Sheet,s=$text.uuid;i.setView({type:"code",layout:$layout.fill,props:{id:s,lineNumbers:!0,theme:$device.isDarkMode?"atom-one-dark":"atom-one-light",text:e.string,insets:$insets(15,15,15,15)}}).addNavBar({title:t.file,popButton:{title:$l10n("CLOSE")},rightButtons:[{title:$l10n("SAVE"),tapped:()=>{$file.write({data:$data({string:$(s).text}),path:t.path}),$ui.success($l10n("SAVE_SUCCESS"))}}]}),i.init().present()}}getFiles(t=""){return $file.list(t).map(i=>{let s=t+"/"+i,o=$file.isDirectory(s);return{info:{info:{path:s,file:i,isDirectory:o}},icon:{symbol:o?"folder.fill":"doc"},name:{text:i},size:{text:o?"":"--"}}}).sort((i,s)=>{if(i.info.info.isDirectory!==s.info.info.isDirectory)return i.info.info.isDirectory?-1:1;if(i.info.info.isDirectory===s.info.info.isDirectory)return i.info.info.file.localeCompare(s.info.info.file)})}async loadFileSize(t){return t.map((e,i)=>{let s=e.info.info;if(!s.isDirectory)try{t[i].size.text=UIKit.bytesToSize($file.read(s.path).info.size)}catch(o){t[i].size.text=o}}),t}get listTemplate(){return{props:{bgcolor:$color("clear")},views:[{props:{id:"info"}},{type:"image",props:{id:"icon"},layout:(t,e)=>{t.centerY.equalTo(e.super),t.left.inset(this.edges),t.size.equalTo(this.iconSize)}},{type:"view",views:[{type:"label",props:{id:"size",color:$color("secondaryText"),lines:1},layout:(t,e)=>{t.height.equalTo(e.super),t.right.inset(this.edges)}},{type:"label",props:{id:"name",lines:1},layout:(t,e)=>{t.height.left.equalTo(e.super),t.right.equalTo(e.prev.left).offset(-this.edges)}}],layout:(t,e)=>{t.height.right.equalTo(e.super),t.left.equalTo(e.prev.right).offset(this.edges)}}]}}#t(t,e){if(this.viewController){let i=new NavigationView;i.setView(e).navigationBarTitle(t),i.navigationBar.setLargeTitleDisplayMode(NavigationBar.largeTitleDisplayModeNever),this.viewController.push(i)}else UIKit.push({title:t,views:[e]})}getListView(t=""){return{type:"list",props:{id:this.listId,menu:this.menu,info:{basePath:t},bgcolor:UIKit.primaryViewBackgroundColor,separatorInset:$insets(0,this.edges,0,0),data:[],template:this.listTemplate,actions:[{title:" "+$l10n("DELETE")+" ",color:$color("red"),handler:(e,i)=>{let s=e.object(i).info.info;UIKit.deleteConfirm($l10n("FILE_MANAGER_DELETE_CONFIRM_MSG")+' "'+s.file+'" ?',()=>{this.delete(s),e.delete(i)})}}]},layout:$layout.fill,events:{ready:()=>{let e=this.getFiles(t);$(this.listId).data=e,this.loadFileSize(e).then(i=>{$(this.listId).data=i})},pulled:async e=>{let i=this.getFiles($(this.listId).info.basePath);$(this.listId).data=i,$(this.listId).data=await this.loadFileSize(i),$delay(.5,()=>{e.endRefreshing()})},didSelect:(e,i,s)=>{let o=s.info.info;o.isDirectory?this.#t(o.file,this.getListView(o.path)):this.edit(o)}}}}push(t=""){let e=t.substring(t.lastIndexOf("/"));this.#t(e,this.getListView(t))}},FileStorage=class r{basePath;constructor({basePath:t="storage"}={}){this.basePath=t,this.#t(this.basePath)}static join(...t){let e=t.length,i=t[0];if(e<2)return i;for(let s=0;s<e-1;++s){let o=t[s+1];o.startsWith("/")&&(o=o.substring(1)),i=i.endsWith("/")?i+o:i+"/"+o}return i}#t(t){$file.isDirectory(t)||$file.mkdir(t)}filePath(t="",e=!0){t=r.join(this.basePath,t);let i="";if(!t.endsWith("/")){let s=t.lastIndexOf("/");t.lastIndexOf(".")>s&&(i=t.substring(s+1),t=t.substring(0,s+1))}return e&&this.#t(t),t+i}exists(t=""){return t=this.filePath(t,!1),!!$file.exists(t)}write(t="",e){return new Promise((i,s)=>{try{let o=this.writeSync(t,e);o?i(o):s(o)}catch(o){s(o)}})}writeSync(t="",e){if(!e)throw new FileStorageParameterError("data");return $file.write({data:e,path:this.filePath(t)})}read(t=""){return new Promise((e,i)=>{try{let s=this.readSync(t);s?e(s):i()}catch(s){i(s)}})}readSync(t=""){if(t=this.filePath(t),!$file.exists(t))throw new FileStorageFileNotFoundError(t);return $file.isDirectory(t)?$file.list(t):$file.read(t)}readAsJSON(t="",e=null){try{let i=this.readSync(t)?.string;return JSON.parse(i)}catch{return e}}static readFromRoot(t=""){return new Promise((e,i)=>{try{let s=r.readFromRootSync(t);s?e(s):i()}catch(s){i(s)}})}static readFromRootSync(t=""){if(!t)throw new FileStorageParameterError("path");if(!$file.exists(t))throw new FileStorageFileNotFoundError(t);return $file.isDirectory(t)?$file.list(t):$file.read(t)}static readFromRootAsJSON(t="",e=null){try{let i=r.readFromRootSync(t)?.string;return JSON.parse(i)}catch{return e}}delete(t=""){return $file.delete(this.filePath(t,!1))}copy(t,e){t=this.filePath(t),e=this.filePath(e),$file.copy({src:t,dst:e})}move(t,e){t=this.filePath(t),e=this.filePath(e),$file.move({src:t,dst:e})}},Kernel=class r{startTime=Date.now();isUseJsboxNav=!1;title=$addin?.current?.name;constructor(){$app.isDebugging&&this.debug(),L10n.init()}static isTaio=$app.info.bundleID.includes("taio");static objectEqual(t,e){let i=Object.getOwnPropertyNames(t),s=Object.getOwnPropertyNames(e);if(i.length!==s.length)return!1;for(let o=0;o<i.length;o++){let a=i[o],n=t[a],l=e[a];if(Array.isArray(n)){for(let h=0;h<n.length;h++)if(!r.objectEqual(n[h],l[h]))return!1}else{if(typeof n=="object")return r.objectEqual(n,l);if(n!==l)return!1}}return!0}static versionCompare(t="",e=""){let i=t.split("."),s=e.split("."),o=Math.max(i.length,s.length),a=0;for(let n=0;n<o;++n){let l=i.length>n?i[n]:0,h=isNaN(Number(l))?l.charCodeAt():Number(l),u=s.length>n?s[n]:0,c=isNaN(Number(u))?u.charCodeAt():Number(u);if(h<c){a=-1;break}else if(h>c){a=1;break}}return a}debug(t,e){this.debugMode=!0,$app.idleTimerDisabled=!0,typeof t=="function"&&(this.debugPrint=t),typeof e=="function"&&(this.debugError=e),this.print("You are running EasyJsBox in debug mode.")}print(t){this.debugMode&&(typeof this.debugPrint=="function"?this.debugPrint(t):console.log(t))}error(t){this.debugMode&&(typeof this.debugError=="function"?this.debugError(t):console.error(t))}useJsboxNav(){return this.isUseJsboxNav=!0,this}setTitle(t){this.isUseJsboxNav&&($ui.title=t),this.title=t}setNavButtons(t){this.navButtons=t}openInJsbox(){$app.openURL(`jsbox://run?name=${this.title}`)}UIRender(t={}){let e=$context.query;if(e.type==="alertFromKeyboard"){let i=JSON.parse($text.URLDecode(e.value));i.actions=[{title:$l10n("CANCEL")}],$ui.alert(i);return}try{t.props=Object.assign({title:this.title,navBarHidden:!this.isUseJsboxNav,navButtons:this.navButtons??[],statusBarStyle:0},t.props),t.events||(t.events={});let i=t.events.layoutSubviews;t.events.layoutSubviews=()=>{$app.notify({name:"interfaceOrientationEvent",object:{statusBarOrientation:UIKit.statusBarOrientation,isHorizontal:UIKit.isHorizontal}}),typeof i=="function"&&i()},$ui.render(t)}catch(i){this.print(i)}}KeyboardRender(t={}){t.id||(t.id=$text.uuid),$ui.render({events:t.events??{}}),$delay(0,()=>{$ui.controller.view=$ui.create(t),$ui.controller.view.layout(t.layout)})}async checkUpdate(){let t="dev",e=await $http.get(`https://raw.githubusercontent.com/ipuppet/EasyJsBox/${t}/src/version.js`);if(e.error)throw e.error;let i=e.data.match(/.*VERSION.+\"([0-9\.]+)\"/)[1];if(this.print(`easy-jsbox latest version: ${i}`),r.versionCompare(i,VERSION)>0){let s=await $http.get(`https://raw.githubusercontent.com/ipuppet/EasyJsBox/${t}/dist/easy-jsbox.js`);if(s.error)throw s.error;return s.data}return!1}},L10n=class{static l10n(t,e,i){if(typeof e=="string"){let o={};e.split(";").forEach(n=>{if(n=n.trim(),n!==""){let l=n.split("=");o[l[0].trim().slice(1,-1)]=l[1].trim().slice(1,-1)}}),e=o}let s=$app.strings;if(i)Object.assign(s[t],e);else for(let o in e)s[t][o]||(s[t][o]=e[o]);$app.strings=s}static set(t,e){this.l10n(t,e,!0)}static add(t,e){this.l10n(t,e,!1)}static init(){this.add("zh-Hans",{OK:"\u597D",DONE:"\u5B8C\u6210",CANCEL:"\u53D6\u6D88",CLEAR:"\u6E05\u9664",BACK:"\u8FD4\u56DE",ERROR:"\u53D1\u751F\u9519\u8BEF",SUCCESS:"\u6210\u529F",INVALID_VALUE:"\u975E\u6CD5\u53C2\u6570",CONFIRM_CHANGES:"\u6570\u636E\u5DF2\u53D8\u5316\uFF0C\u786E\u8BA4\u4FEE\u6539\uFF1F",SETTING:"\u8BBE\u7F6E",GENERAL:"\u4E00\u822C",ADVANCED:"\u9AD8\u7EA7",TIPS:"\u5C0F\u8D34\u58EB",COLOR:"\u989C\u8272",COPY:"\u590D\u5236",COPIED:"\u590D\u5236\u6210\u529F",JSBOX_ICON:"JSBox \u5185\u7F6E\u56FE\u6807",SF_SYMBOLS:"SF Symbols",IMAGE_BASE64:"\u56FE\u7247 / base64",PREVIEW:"\u9884\u89C8",SELECT_IMAGE_PHOTO:"\u4ECE\u76F8\u518C\u9009\u62E9\u56FE\u7247",SELECT_IMAGE_ICLOUD:"\u4ECE iCloud \u9009\u62E9\u56FE\u7247",CLEAR_IMAGE:"\u6E05\u9664\u56FE\u7247",NO_IMAGE:"\u65E0\u56FE\u7247",ABOUT:"\u5173\u4E8E",VERSION:"Version",AUTHOR:"\u4F5C\u8005",AT_BOTTOM:"\u5DF2\u7ECF\u5230\u5E95\u5566~"}),this.add("en",{OK:"OK",DONE:"Done",CANCEL:"Cancel",CLEAR:"Clear",BACK:"Back",ERROR:"Error",SUCCESS:"Success",INVALID_VALUE:"Invalid value",CONFIRM_CHANGES:"The data has changed, confirm the modification?",SETTING:"Setting",GENERAL:"General",ADVANCED:"Advanced",TIPS:"Tips",COLOR:"Color",COPY:"Copy",COPIED:"Copide",JSBOX_ICON:"JSBox in app icon",SF_SYMBOLS:"SF Symbols",IMAGE_BASE64:"Image / base64",PREVIEW:"Preview",SELECT_IMAGE_PHOTO:"Select From Photo",SELECT_IMAGE_ICLOUD:"Select From iCloud",CLEAR_IMAGE:"Clear Image",NO_IMAGE:"No Image",ABOUT:"About",VERSION:"Version",AUTHOR:"Author",AT_BOTTOM:"It's the end~"}),this.add("zh-Hans",{DELETE_CONFIRM_TITLE:"\u5220\u9664\u524D\u786E\u8BA4"}),this.add("en",{DELETE_CONFIRM_TITLE:"Delete Confirmation"}),this.add("zh-Hans",{FILE_MANAGER_DELETE_CONFIRM_MSG:"\u786E\u8BA4\u8981\u5220\u9664\u5417",DELETE:"\u5220\u9664",CANCEL:"\u53D6\u6D88",CLOSE:"\u5173\u95ED",SHARE:"\u5206\u4EAB",SAVE:"\u4FDD\u5B58",SAVE_SUCCESS:"\u4FDD\u5B58\u6210\u529F"}),this.add("en",{FILE_MANAGER_DELETE_CONFIRM_MSG:"Are you sure you want to delete",DELETE:"Delete",CANCEL:"Cancel",CLOSE:"Close",SHARE:"Share",SAVE:"Save",SAVE_SUCCESS:"Save Success"})}},Logger=class{print;constructor(t){this.print=t??console.log}printToFile(t,e){this.print=i=>{t.exists(e)&&(i=(t.readSync(e)?.string??"")+i),t.writeSync(e,$data({string:i}))}}format(t,e){return`${new Date().toUTCString()} [${e}] ${t}
`}log(t,e){this.print(this.format(t,e))}info(t){this.log(t,"INFO")}error(t){this.log(t,"ERROR")}alert(t){this.log(t,"ALERT")}},NavigationBarItems=class{rightButtons=[];leftButtons=[];#t={};hasbutton=!1;isPinTitleView=!1;setTitleView(t){return this.titleView=t,this}pinTitleView(){return this.isPinTitleView=!0,this}setFixedFooterView(t){return this.fixedFooterView=t,this}setRightButtons(t){return t.forEach(e=>this.addRightButton(e)),this.hasbutton||(this.hasbutton=!0),this}setLeftButtons(t){return t.forEach(e=>this.addLeftButton(e)),this.hasbutton||(this.hasbutton=!0),this}addRightButton({id:t,symbol:e,title:i,tapped:s,menu:o,events:a,color:n}={}){let l=BarButtonItem.creat({id:t,symbol:e,title:i,tapped:s,menu:o,events:a,color:n,align:UIKit.align.right});return this.rightButtons.push(l),this.#t[t??l.id]=l,this.hasbutton||(this.hasbutton=!0),this}addLeftButton({id:t,symbol:e,title:i,tapped:s,menu:o,events:a,color:n}={}){let l=BarButtonItem.creat({id:t,symbol:e,title:i,tapped:s,menu:o,events:a,color:n,align:UIKit.align.left});return this.leftButtons.push(l),this.#t[t??l.id]=l,this.hasbutton||(this.hasbutton=!0),this}getButton(t){return this.#t[t]}addPopButton(t,e,i){return t||(t=$l10n("BACK")),this.popButtonView=e??{type:"button",props:{bgcolor:$color("clear"),symbol:"chevron.left",tintColor:UIKit.linkColor,title:` ${t}`,titleColor:UIKit.linkColor,font:$font("bold",16)},layout:(s,o)=>{s.left.equalTo(o.super.safeArea).offset(BarButtonItem.style.edges),s.centerY.equalTo(o.super.safeArea)},events:{tapped:()=>{$ui.pop(),typeof i=="function"&&i()}}},this}removePopButton(){return this.popButtonView=void 0,this}},Plist=class{constructor(t){this.content=t}valueToJs(t){switch(t.tag){case"dict":return this.dictToJs(t);case"true":case"false":return t.tag==="true";case"integer":return t.number;case"key":case"string":return t.string;case"date":return new Date(t.string);case"array":return this.arrayToJs(t);default:return t.node}}arrayToJs(t){let e=[];return t.children().forEach(i=>{e.push(this.valueToJs(i))}),e}dictToJs(t){let e=[],i=[];return t.children().forEach(s=>{s.tag==="key"?e.push(this.valueToJs(s)):i.push(this.valueToJs(s))}),Object.fromEntries(e.map((s,o)=>[s,i[o]]))}getObject(){if(!this.content)return!1;let t=$xml.parse({string:this.content,mode:"xml"});return this.valueToJs(t.rootElement.firstChild({xPath:"//plist/dict"}))}static get(t){return new this(t).getObject()}},Request=class r{static method={get:"GET",post:"POST",put:"PUT",delete:"DELETE",patch:"PATCH",head:"HEAD",options:"OPTIONS"};static errorType={http:0,network:1};cacheContainerKey=$addin?.current?.name+".request.cache";#t;#e=!1;#s=!1;cacheLife=1e3*60*60*24*30;#i=!1;timeout=5;logger;constructor(t){typeof t=="function"&&(this.logger=t)}get cache(){return $cache.get(this.cacheContainerKey)??{}}#r(t){this.#i&&typeof this.logger=="function"&&this.logger(t)}logRequest(t){return this.#i=!0,typeof t=="function"&&(this.logger=t),this}disableLogRequest(){this.#i=!1}getCacheKey(t){return $text.MD5(t)}getCache(t,e=null){return this.cache[t]??e}setCache(t,e){if(!e)return;let i=this.cache;i[t]=e,$cache.set(this.cacheContainerKey,i)}removeCache(t){let e=this.cache;delete e[t],$cache.set(this.cacheContainerKey,e)}clearCache(){$cache.remove(this.cacheContainerKey)}clearNSURLCache(){this.#t||(this.#t=$objc("NSURLCache").$sharedURLCache()),this.#t.$removeAllCachedResponses()}enableCache(){return this.#e=!0,this}disableCache(){return this.#e=!1,this}ignoreCacheExp(){this.#s=!0}async request(t,e,i={},s={},o=this.cacheLife,a){let n,l=this.#e&&e===r.method.get;if(l){n=this.getCacheKey(t);let u=this.getCache(n);if(u&&(this.#s||u.exp>Date.now()))return this.#r("get data from cache: "+t),u.data}this.#r(`sending request [${e}]: ${t}`);let h=await $http.request(Object.assign({header:s,url:t,method:e,body:e===r.method.get?null:i,timeout:this.timeout},a));if(h.error)throw new RequestError({type:r.errorType.network,message:h.error.localizedDescription,code:h.error.code});if(h?.response?.statusCode>=400){let u=h.data;throw typeof u=="object"&&(u=JSON.stringify(u)),new RequestError({type:r.errorType.http,message:u,code:h.response.statusCode})}return l&&this.setCache(n,{exp:Date.now()+o,data:h}),h}},SettingItem=class _SettingItem{static rowHeight=50;static edgeOffset=10;static iconSize=30;static iconDefaultColor="#00CC00";setting;method;#id;#key;#icon;title;#options=[];constructor(r,t,e,i){this.setting=r,this.method=this.setting?.method??{},this.key=t,this.title=e,this.icon=i}set key(r){return this.#key=r??$text.uuid,this.#id=void 0,this}get key(){return this.#key}get id(){return this.#id||(this.#id=`setting-${this.setting.name}-${this.key}`),this.#id}set icon(r){return r?Array.isArray(r)||(r=[r,_SettingItem.iconDefaultColor]):r=["square.grid.2x2.fill",_SettingItem.iconDefaultColor],Array.isArray(r[0])||(r[0]=[r[0],r[0]]),r[1]?Array.isArray(r[1])||(r[1]=[r[1],r[1]]):r[1]=[_SettingItem.iconDefaultColor,_SettingItem.iconDefaultColor],this.#icon=r,this}get icon(){return this.#icon}set(r){return this.setting.set(this.key,r)}get(r=null){return this.setting.getOriginal(this.key,r)}evalValues(object){let result;return typeof object=="string"?object.startsWith("this.method")?result=eval(`(()=>{return ${object}()})()`):result=eval(`(()=>{return ${object}})()`):typeof object=="function"?result=object():result=object??[],result}getId(r){return`setting-${this.setting.name}-${r}`}createLineLabel(){return{type:"view",views:[{type:"view",props:{bgcolor:$color(this.icon[1][0],this.icon[1][1]),cornerRadius:5,smoothCorners:!0},views:[{type:"image",props:{tintColor:$color("white"),image:$image(this.icon[0][0],this.icon[0][1])},layout:(r,t)=>{r.center.equalTo(t.super),r.size.equalTo(20)}}],layout:(r,t)=>{r.centerY.equalTo(t.super),r.size.equalTo(_SettingItem.iconSize),r.left.inset(_SettingItem.edgeOffset)}},{type:"label",props:{text:this.title,lines:1,align:$align.left},layout:(r,t)=>{r.centerY.equalTo(t.super),r.height.equalTo(t.super),r.left.equalTo(t.prev.right).offset(_SettingItem.edgeOffset),r.width.greaterThanOrEqualTo(10)}}],layout:(r,t)=>{r.height.centerY.equalTo(t.super),r.left.inset(0)}}}options(...r){return this.#options=r??[],this}getView(){}create(){return this.getView(...this.#options)}static from(r){return new this(r.setting,r.key,r.title,r.icon)}},Sheet=class r{#t=()=>{};#e=()=>{};style=r.UIModalPresentationStyle.PageSheet;#s=!1;#i;static UIModalPresentationStyle={Automatic:-2,FullScreen:0,PageSheet:1,FormSheet:2,CurrentContext:3,Custom:4,OverFullScreen:5,OverCurrentContext:6,Popover:7,BlurOverFullScreen:8};navigationView;init(){this.initNavBar();let{width:t,height:e}=$device.info.screen,i=$objc("UIView").invoke("initWithFrame",$rect(0,0,t,e)),s=$objc("UIViewController").invoke("alloc.init"),o=s.$view();return o.$addSubview(i),s.$setModalPresentationStyle(this.style),s.$setModalInPresentation(this.#s),this.#t=()=>{o.jsValue().add(this.navigationView?.getPage().definition??this.view),$ui.vc.ocValue().invoke("presentViewController:animated:completion:",s,!0,void 0)},this.#e=()=>s.invoke("dismissViewControllerAnimated:completion:",!0,void 0),this}initNavBar(){if(!this.#i)return;let{title:t="",popButton:e={title:$l10n("CLOSE")},rightButtons:i=[]}=this.#i;if(this.view===void 0)throw new SheetViewUndefinedError;this.navigationView=new NavigationView;let s=this.navigationView.navigationBar;s.setLargeTitleDisplayMode(NavigationBar.largeTitleDisplayModeNever),s.navigationBarLargeTitleHeight-=s.navigationBarNormalHeight,s.navigationBarNormalHeight=NavigationBar.pageSheetNavigationBarHeight,s.navigationBarLargeTitleHeight+=s.navigationBarNormalHeight,this.style===r.UIModalPresentationStyle.FullScreen||this.style===r.UIModalPresentationStyle.OverFullScreen||this.style===r.UIModalPresentationStyle.BlurOverFullScreen?s.setTopSafeArea():s.removeTopSafeArea(),e.events=Object.assign({tapped:()=>{this.dismiss(),typeof e.tapped=="function"&&e.tapped()}},e.events??{}),this.navigationView.navigationBarItems.addLeftButton(e).setRightButtons(i),this.navigationView.setView(this.view).navigationBarTitle(t),this.view.props?.bgcolor&&this.navigationView?.getPage().setProp("bgcolor",this.view.props?.bgcolor)}preventDismiss(){return this.#s=!0,this}setStyle(t){return this.style=t,this}setView(t={}){if(typeof t!="object")throw new SheetViewTypeError("view","object");return this.view=t,this}addNavBar(t){return this.#i=t,this}present(){this.#t()}dismiss(){this.#e()}static quickLookImage(t,e=$l10n("PREVIEW")){new r().setView({type:"view",views:[{type:"scroll",props:{zoomEnabled:!0,maxZoomScale:3},layout:$layout.fill,views:[{type:"image",props:{data:t},layout:$layout.fill}]}],layout:$layout.fill}).addNavBar({title:e,rightButtons:[{symbol:"square.and.arrow.up",tapped:()=>$share.sheet(t)}]}).init().present()}},Tasks=class{#t={};addTask(t,e=0){let i=$text.uuid;return this.#t[i]=$delay(e,async()=>{await t(),delete this.#t[i]}),i}cancelTask(t){this.#t[t].cancel()}clearTasks(){Object.values(this.#t).forEach(t=>t.cancel())}},Toast=class r{static type={info:void 0,success:"checkmark",warning:"exclamationmark.triangle",error:"xmark.circle"};static edges=40;static iconSize=100;static labelTopMargin=10;static defaultFont=$font("default",26);width=Math.min(UIKit.windowSize.width*.6,260);labelWidth=this.width-r.edges*2;id=$text.uuid;#t="";font=r.defaultFont;type=r.type.info;labelLines=2;constructor(t,e=r.type.info,i=2,s=r.defaultFont){this.type=e,this.message=t,this.labelLines=i,this.font=s}get message(){return this.#t}set message(t){this.#t=t,this.fontHeight=UIKit.getContentSize(this.font,this.message,this.labelWidth,this.labelLines).height,this.height=(this.hasIcon?r.labelTopMargin+r.iconSize:0)+this.fontHeight+r.edges*2}get hasIcon(){return this.type!==void 0}get blurBox(){let t=UIKit.blurBox({id:this.id,cornerRadius:15,alpha:0},[{type:"image",props:{symbol:this.type,hidden:!this.hasIcon,tintColor:$color("lightGray")},layout:(e,i)=>{e.top.inset(r.edges),e.size.equalTo(r.iconSize),e.centerX.equalTo(i.super)}},{type:"label",props:{font:this.font,text:this.message,align:$align.center,lines:this.labelLines,color:$color("lightGray")},layout:(e,i)=>{e.bottom.equalTo(i.supper).offset(-r.edges),e.width.equalTo(this.labelWidth),e.height.equalTo(this.fontHeight),e.centerX.equalTo(i.super)}}]);return t.events={tapped:()=>{this.remove()}},t}show(){let t=$ui.create(this.blurBox);$ui.controller.view.hidden?$ui.controller.view.super.insertAtIndex(t,0):$ui.controller.view.insertAtIndex(t,0);let e=$(this.id);e.layout((i,s)=>{i.center.equalTo(s.super),i.size.equalTo($size(this.width,this.height))}),e.moveToFront(),$ui.animate({duration:.2,animation:()=>{e.alpha=1}})}remove(){let t=$(this.id);t&&$ui.animate({duration:.2,animation:()=>{t.alpha=0},completion:()=>{t.remove()}})}static toast({message:t,type:e=r.type.info,show:i=!0,displayTime:s=2,labelLines:o=2,font:a=r.defaultFont}){let n=new r(t,e,o,a);return i&&(n.show(),$delay(s,()=>{n.remove()})),n}static info(t,e={}){return r.toast(Object.assign({message:t,type:r.type.info},e))}static success(t,e={}){return r.toast(Object.assign({message:t,type:r.type.success},e))}static warning(t,e={}){return r.toast(Object.assign({message:t,type:r.type.warning},e))}static error(t,e={}){return r.toast(Object.assign({message:t,type:r.type.error},e))}},UIKit=class r{static#t=$objc("UIApplication").$sharedApplication();static#e=$objc("UINotificationFeedbackGenerator").$new();static feedbackSuccess(){r.#e.$notificationOccurred(0)}static feedbackError(){r.#e.$notificationOccurred(2)}static align={left:0,right:1,top:2,bottom:3};static textColor=$color("primaryText");static linkColor=$color("systemLink");static primaryViewBackgroundColor=$color("primarySurface");static scrollViewBackgroundColor=$color("insetGroupedBackground");static scrollViewList=["list","matrix"];static isLargeScreen=$device.isIpad||$device.isIpadPro;static get windowSize(){return $objc("UIWindow").$keyWindow().jsValue().size}static NavigationBarNormalHeight=$objc("UINavigationController").invoke("alloc.init").$navigationBar().jsValue().frame.height;static NavigationBarLargeTitleHeight=$objc("UITabBarController").invoke("alloc.init").$tabBar().jsValue().frame.height+r.NavigationBarNormalHeight;static get isSplitScreenMode(){return r.isLargeScreen&&$device.info.screen.width!==r.windowSize.width}static get topSafeAreaInsets(){return r.#t?.$keyWindow()?.$safeAreaInsets()?.top??0}static get bottomSafeAreaInsets(){return r.#t?.$keyWindow()?.$safeAreaInsets()?.bottom??0}static get statusBarOrientation(){return r.#t.$statusBarOrientation()}static get consoleBarHeight(){if($app.isDebugging){let t=r.#t.$statusBarFrame().height+26;return $device.isIphoneX&&(t+=30),t}return 0}static get isHorizontal(){return r.statusBarOrientation===3||r.statusBarOrientation===4}static loading(){let t=$ui.create(r.blurBox({cornerRadius:15},[{type:"spinner",props:{loading:!0,style:0},layout:(e,i)=>{e.size.equalTo(i.prev),e.center.equalTo(i.super)}}]));return{start:()=>{$ui.controller.view.insertAtIndex(t,0),t.layout((e,i)=>{e.center.equalTo(i.super);let s=Math.min(Math.min(r.windowSize.width,r.windowSize.height)*.6,260);e.size.equalTo($size(s,s))}),t.moveToFront()},end:()=>{t.remove()}}}static defaultBackgroundColor(t){return r.scrollViewList.indexOf(t)>-1?r.scrollViewBackgroundColor:r.primaryViewBackgroundColor}static separatorLine(t={},e=r.align.bottom){return{type:"canvas",props:t,layout:(i,s)=>{s.prev===void 0?i.top.equalTo(s.super):e===r.align.bottom?i.top.equalTo(s.prev.bottom):i.top.equalTo(s.prev.top),i.height.equalTo(1/$device.info.screen.scale),i.left.right.inset(0)},events:{draw:(i,s)=>{s.strokeColor=t.bgcolor??$color("separatorColor"),s.setLineWidth(1),s.moveToPoint(0,0),s.addLineToPoint(i.frame.width,0),s.strokePath()}}}}static blurBox(t={},e=[],i=$layout.fill){return{type:"blur",props:Object.assign({style:$blurStyle.thinMaterial},t),views:e,layout:i}}static getContentSize(t,e="A",i=r.windowSize.width,s=void 0){let o={text:e,width:i,font:t};return s!==void 0&&(o.lineSpacing=s),$text.sizeThatFits(o)}static getSymbolSize(t,e){t=typeof t=="string"?$image(t):t;let i=t.size.width/t.size.height;return t.size.width>t.size.height?$size(e,e/i):$size(e*i,e)}static push({views:t,statusBarStyle:e=0,title:i="",navButtons:s=[{title:""}],bgcolor:o=t[0]?.props?.bgcolor??"primarySurface",titleView:a=void 0,disappeared:n}={}){let l={statusBarStyle:e,navButtons:s,title:i,bgcolor:typeof o=="string"?$color(o):o};a&&(l.titleView=a),$ui.push({props:l,events:{disappeared:()=>{n!==void 0&&n()}},views:[{type:"view",views:t,layout:(h,u)=>{h.top.equalTo(u.super.safeArea),h.bottom.equalTo(u.super),h.left.right.equalTo(u.super.safeArea)}}]})}static compressImage(t,e=1280*720){let i=$imagekit.info(t);if(i.height*i.width>e){let s=e/(i.height*i.width);t=$imagekit.scaleBy(t,s)}return t}static deleteConfirm(t,e){$ui.alert({title:$l10n("DELETE_CONFIRM_TITLE"),message:t,actions:[{title:$l10n("DELETE"),style:$alertActionType.destructive,handler:()=>{e()}},{title:$l10n("CANCEL")}]})}static bytesToSize(t){if(t===0)return"0 B";let e=1024,i=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],s=Math.floor(Math.log(t)/Math.log(e));return(t/Math.pow(e,s)).toPrecision(3)+" "+i[s]}},UILoading=class{#t;text="";interval;fullScreen=!1;#e=()=>{};constructor(){this.#t=$text.uuid}updateText(t){$(this.#t).text=t}setLoop(t){if(typeof t!="function")throw"loop must be a function";this.#e=t}done(){clearInterval(this.interval)}load(){$ui.render({props:{navBarHidden:this.fullScreen},views:[{type:"spinner",props:{loading:!0},layout:(t,e)=>{t.centerY.equalTo(e.super).offset(-15),t.width.equalTo(e.super)}},{type:"label",props:{id:this.#t,align:$align.center,text:""},layout:(t,e)=>{t.top.equalTo(e.prev.bottom).offset(10),t.left.right.equalTo(e.super)}}],layout:$layout.fill,events:{appeared:()=>{this.interval=setInterval(()=>{this.#e()},100)}}})}},View=class r{id=$text.uuid;type;props;views;events;layout;#t=void 0;#e=null;constructor({type:t="view",props:e={},views:i=[],events:s={},layout:o=$layout.fill}={}){this.type=t,this.props=e,this.views=i,this.events=s,this.layout=o,this.props.id?this.id=this.props.id:this.props.id=this.id}static create(t){return new this(t)}static createFromViews(t){return new this({views:t})}get scrollableView(){return this.scrollable?this.#e:null}set scrollableView(t){this.#e=t}get scrollable(){if(this.#t===void 0){if(this.#t=!1,UIKit.scrollViewList.indexOf(this.type)>-1)this.scrollableView=this,this.#t=!0;else if(this.views.length>0){let t=e=>{if(!this.#t&&e?.length>0)for(let i=0;i<e.length;i++)if(UIKit.scrollViewList.indexOf(e[i].type)>-1){typeof e[i]!==r&&(e[i]=r.create(e[i])),this.scrollableView=e[i],this.#t=!0;return}else t(e[i].views)};t(this.views)}}return this.#t}set scrollable(t){throw new Error("[scrollable] is readonly prop.")}setProps(t){return Object.keys(t).forEach(e=>this.setProp(e,t[e])),this}setProp(t,e){return t==="id"&&(this.id=e),this.props[t]=e,this}setViews(t){return this.views=t,this.#t=void 0,this}setEvents(t){return Object.keys(t).forEach(e=>this.setEvent(e,t[e])),this}setEvent(t,e){return this.events[t]=e,this}eventMiddleware(t,e){let i=this.events[t];return this.events[t]=(...s)=>{typeof i=="function"&&e(i,...s)},this}assignEvent(t,e){let i=this.events[t];return this.events[t]=(...s)=>{typeof i=="function"&&i(...s),e(...s)},this}setLayout(t){return this.layout=t,this}getView(){return this}get definition(){return this.getView()}},FileStorageParameterError=class extends Error{constructor(t){super(`Parameter [${t}] is required.`),this.name="FileStorageParameterError"}},FileStorageFileNotFoundError=class extends Error{constructor(t){super(`File not found: ${t}`),this.name="FileStorageFileNotFoundError"}},RequestError=class extends Error{constructor({message:t,code:e,type:i}={}){super(t),this.name="RequestError",this.code=e,this.type=i}},SettingLoadConfigError=class extends Error{constructor(){super("Call loadConfig() first."),this.name="SettingLoadConfigError"}},SettingReadonlyError=class extends Error{constructor(){super("Attempted to assign to readonly property."),this.name="SettingReadonlyError"}},SheetViewUndefinedError=class extends Error{constructor(){super("Please call setView(view) first."),this.name="SheetViewUndefinedError"}},ValidationError=class extends Error{constructor(t,e){super(`The type of the parameter '${t}' must be '${e}'`),this.name="ValidationError"}},FixedFooterView=class extends View{height=60;getView(){return this.type="view",this.setProp("bgcolor",UIKit.primaryViewBackgroundColor),this.layout=(t,e)=>{t.left.right.bottom.equalTo(e.super),t.top.equalTo(e.super.safeAreaBottom).offset(-this.height)},this.views=[View.create({props:this.props,views:this.views,layout:(t,e)=>{t.left.right.top.equalTo(e.super),t.height.equalTo(this.height)}})],this}},Matrix=class extends View{titleStyle={font:$font("bold",21),height:30};#t;#e;templateIdByIndex(t){return this.props.template.views[t]?.props?.id===void 0&&(this.props.template.views[t].props===void 0&&(this.props.template.views[t].props={}),this.props.template.views[t].props.id=$text.uuid),this.props.template.views[t].props.id}get templateHiddenStatus(){if(!this.#e){this.#e={};for(let t=0;t<this.props.template.views.length;t++)this.props.template.views[t].props.id===void 0&&this.props.template.views[t].props.hidden===void 0&&(this.#e[this.templateIdByIndex(t)]=!1),this.props.template.views[t].props.hidden!==void 0&&(this.#e[this.templateIdByIndex(t)]=this.props.template.views[t].props.hidden)}return this.#e}get hiddenViews(){if(!this.#t){this.#t={};for(let t=0;t<this.props.template.views.length;t++)this.#t[this.templateIdByIndex(t)]={hidden:!0}}return this.#t}get data(){let t=$(this.id).data,e=[];return t.map(i=>{i.items=i.items.filter(s=>s?.__title?.hidden===!0),e.push(i)}),e}set data(t){this.props.data=this.rebuildData(t),$(this.id).data=this.props.data}#s(t){let e={...this.hiddenViews};return Object.assign(e,{__templateProps:{hidden:!0},__title:{hidden:!1,text:t,info:{title:!0}}}),e}rebuildData(t=[]){return t.map(e=>(e.items=e.items.map(i=>(Object.keys(i).forEach(s=>{i[s].hidden=this.templateHiddenStatus[s]??!1}),Object.keys(this.templateHiddenStatus).forEach(s=>{i[s]||(i[s]={}),i[s].hidden=this.templateHiddenStatus[s]}),i.__templateProps={hidden:!1},i.__title={hidden:!0},i)),e.title&&e.items.unshift(this.#s(e.title)),e))}rebuildTemplate(){let t={};this.props.template.props!==void 0&&(this.props.template.props.cornerRadius!==void 0&&(this.props.template.props.clipsToBounds=!1),t=Object.assign(this.props.template.props,{id:"__templateProps",hidden:!1}));let e=[{type:"view",props:t,layout:$layout.fill},{type:"label",props:{id:"__title",hidden:!0,font:this.titleStyle.font},layout:(i,s)=>{i.top.inset(-(this.titleStyle.height/4)*3),i.height.equalTo(this.titleStyle.height),i.width.equalTo(s.super.safeArea)}}].concat(this.props.template.views);this.props.template.views=e}insert(t,e=!0){return t.indexPath=this.indexPath(t.indexPath,e),$(this.id).insert(t)}delete(t,e=!0){return t=this.indexPath(t,e),$(this.id).delete(t)}object(t,e=!0){return t=this.indexPath(t,e),$(this.id).object(t)}cell(t,e=!0){return t=this.indexPath(t,e),$(this.id).cell(t)}indexPath(t,e){let i=e?1:0;return typeof t=="number"?t=$indexPath(0,t+i):t=$indexPath(t.section,t.row+i),t}getView(){return this.props.data=this.rebuildData(this.props.data),this.rebuildTemplate(),this.setEvent("itemSize",(t,e)=>{if(t.object(e)?.__title?.info?.title)return $size(Math.max($device.info.screen.width,$device.info.screen.height),0);let s=this.props.columns??2,o=this.props.spacing??15,a=this.props.itemWidth??this.props.itemSize?.width??(t.super.frame.width-o*(s+1))/s,n=this.props.itemHeight??this.props.itemSize?.height??100;return $size(a,n)}),this}},BarTitleView=class extends View{controller={};setController(t){return this.controller=t,this}},BarButtonItem=class r extends View{static#t;edges=15;buttonEdges=this.edges/2;iconSize=24;fontSize=17;color=UIKit.textColor;title;#e;align=UIKit.align.right;get symbol(){return this.#e}set symbol(t){this.#e=typeof t=="string"?$image(t):t}get width(){if(this.title){let t=$text.sizeThatFits({text:this.title,width:UIKit.windowSize.width,font:$font(this.fontSize)});return Math.ceil(t.width)+this.edges}return this.iconSize+this.edges}static get style(){return this.#t===void 0&&(this.#t=new r),this.#t}setEdges(t){return this.edges=t,this}setFontSize(t){return this.fontSize=t,this}setColor(t=UIKit.textColor){return this.color=t,this}setTitle(t){return this.title=t,this}setSymbol(t){return this.symbol=t,this}setMenu(t){return this.menu=t,this}setAlign(t){return this.align=t,this}setLoading(t){t?($(this.id).hidden=!0,$("spinner-"+this.id).hidden=!1):($(this.id).hidden=!1,$("spinner-"+this.id).hidden=!0)}#s(){let t=$(`icon-button-${this.id}`),e=$(`icon-checkmark-${this.id}`);t.alpha=0,$(this.id).hidden=!1,$("spinner-"+this.id).hidden=!0,$ui.animate({duration:.6,animation:()=>{e.alpha=1},completion:()=>{$delay(.3,()=>$ui.animate({duration:.6,animation:()=>{e.alpha=0},completion:()=>{$ui.animate({duration:.4,animation:()=>{t.alpha=1},completion:()=>{t.alpha=1}})}}))}})}getView(){let t=this.events.tapped;return this.events.tapped=e=>{t&&t({start:()=>this.setLoading(!0),done:()=>this.#s(),cancel:()=>this.setLoading(!1)},e)},{type:"view",props:{info:{align:this.align}},views:[{type:"button",props:Object.assign({id:this.id,bgcolor:$color("clear"),font:$font(this.fontSize),titleColor:this.color,contentEdgeInsets:$insets(0,0,0,0),titleEdgeInsets:$insets(0,0,0,0),imageEdgeInsets:$insets(0,0,0,0)},this.menu?{menu:this.menu}:{},this.title?{title:this.title}:{},this.props),views:[{type:"image",props:Object.assign({id:`icon-button-${this.id}`,hidden:this.symbol===void 0,tintColor:this.color},this.symbol?{image:this.symbol}:{}),layout:(e,i)=>{this.symbol&&e.size.equalTo(UIKit.getSymbolSize(this.symbol,this.iconSize)),e.center.equalTo(i.super)}},{type:"image",props:{id:`icon-checkmark-${this.id}`,alpha:0,tintColor:this.color,symbol:"checkmark"},layout:(e,i)=>{e.center.equalTo(i.super),e.size.equalTo(UIKit.getSymbolSize("checkmark",this.iconSize))}}],events:this.events,layout:$layout.fill},{type:"spinner",props:{id:"spinner-"+this.id,loading:!0,hidden:!0},layout:$layout.fill}],layout:(e,i)=>{if(e.size.equalTo($size(this.width,UIKit.NavigationBarNormalHeight)),e.centerY.equalTo(i.super),i.prev&&i.prev?.info?.align===this.align)this.align===UIKit.align.right?e.right.equalTo(i.prev.left).offset(-this.buttonEdges):e.left.equalTo(i.prev.right).offset(this.buttonEdges);else{let s=this.edges/2;this.align===UIKit.align.right?e.right.inset(s):e.left.inset(s)}}}}static creat({id:t,symbol:e,title:i,tapped:s,menu:o,events:a,color:n,align:l=UIKit.align.right}={}){let h=new r;return h.setEvents(Object.assign({tapped:s},a)).setAlign(l).setSymbol(e).setTitle(i).setColor(n).setMenu(o),t&&h.setProp("id",t),h}},NavigationBar=class r extends View{static largeTitleDisplayModeAutomatic=0;static largeTitleDisplayModeAlways=1;static largeTitleDisplayModeNever=2;static pageSheetNavigationBarHeight=56;navigationBarItems;title="";prefersLargeTitles=!0;largeTitleDisplayMode=r.largeTitleDisplayModeAutomatic;fontFamily="bold";largeTitleFontSize=34;largeTitleFontHeight=$text.sizeThatFits({text:"A",width:100,font:$font(this.fontFamily,this.largeTitleFontSize)}).height;navigationBarTitleFontSize=17;topSafeArea=!0;contentViewHeightOffset=10;navigationBarNormalHeight=UIKit.NavigationBarNormalHeight;navigationBarLargeTitleHeight=UIKit.NavigationBarLargeTitleHeight;setTopSafeArea(){return this.topSafeArea=!0,this}removeTopSafeArea(){return this.topSafeArea=!1,this}setLargeTitleDisplayMode(t){return this.largeTitleDisplayMode=t,this}setBackgroundColor(t){return this.backgroundColor=t,this}setTitle(t){return this.title=t,this}setPrefersLargeTitles(t){return this.prefersLargeTitles=t,this}setContentViewHeightOffset(t){return this.contentViewHeightOffset=t,this}getLargeTitleView(){return this.prefersLargeTitles&&this.largeTitleDisplayMode!==r.largeTitleDisplayModeNever?{type:"label",props:{id:this.id+"-large-title",text:this.title,textColor:UIKit.textColor,align:$align.left,font:$font(this.fontFamily,this.largeTitleFontSize),line:1},layout:(t,e)=>{t.left.equalTo(e.super.safeArea).offset(15),t.height.equalTo(this.largeTitleFontHeight),t.top.equalTo(e.super.safeAreaTop).offset(this.navigationBarNormalHeight)}}:{props:{id:this.id+"-large-title"},layout:(t,e)=>{t.left.top.right.inset(0),t.bottom.equalTo(e.super.safeAreaTop).offset(this.navigationBarNormalHeight)}}}getNavigationBarView(){let t=(a,n)=>{let l=(g,p)=>{g.top.equalTo(p.super.safeAreaTop),g.bottom.equalTo(p.super.safeAreaTop).offset(this.navigationBarNormalHeight),n===UIKit.align.left?g.left.equalTo(p.super.safeArea):g.right.equalTo(p.super.safeArea)};if(a&&!Array.isArray(a))return{type:"view",views:[a],layout:l};let h=0,u=[];a.forEach(g=>{h+=g.width,u.push(g.definition)});let c=a[0]?.edges??0;return h+=a.length>=2?c*2:c,a.length>0?{type:"view",views:u,info:{width:h},layout:(g,p)=>{l(g,p),g.width.equalTo(h)}}:{type:"view",layout:g=>g.size.equalTo(0)}},e=t(this.navigationBarItems.popButtonView??this.navigationBarItems.leftButtons,UIKit.align.left),i=t(this.navigationBarItems.rightButtons,UIKit.align.right),s=this.prefersLargeTitles,o=!this.prefersLargeTitles||this.largeTitleDisplayMode===r.largeTitleDisplayModeNever;return{type:"view",props:{id:this.id+"-navigation",bgcolor:$color("clear")},layout:(a,n)=>{a.left.top.right.inset(0),a.bottom.equalTo(n.super.safeAreaTop).offset(this.navigationBarNormalHeight)},views:[this.backgroundColor?{type:"view",props:{hidden:s,bgcolor:this.backgroundColor,id:this.id+"-background"},layout:$layout.fill}:UIKit.blurBox({hidden:s,id:this.id+"-background"}),UIKit.separatorLine({id:this.id+"-underline",alpha:s?0:1}),{type:"view",props:{alpha:0,bgcolor:$color("clear"),id:this.id+"-large-title-mask"},events:{ready:a=>{a.bgcolor=$(this.id+"-large-title")?.prev.bgcolor}},layout:$layout.fill},e,i,{type:"view",views:[{type:"label",props:{id:this.id+"-small-title",alpha:o?1:0,text:this.title,font:$font(this.fontFamily,this.navigationBarTitleFontSize),align:$align.center,bgcolor:$color("clear"),textColor:UIKit.textColor},layout:(a,n)=>{a.edges.equalTo(n.super.safeArea);let l=UIKit.getContentSize($font(this.fontFamily,this.navigationBarTitleFontSize),n.text).width,h=Math.max(e.info?.width??0,i.info?.width??0);UIKit.windowSize.width-h*2>l&&a.centerX.equalTo(n.super.super)}}],layout:(a,n)=>{a.top.bottom.equalTo(n.super.safeArea),a.left.equalTo(n.prev.prev.right),a.right.equalTo(n.prev.left)}}]}}},NavigationBarController=class r extends Controller{static largeTitleViewSmallMode=0;static largeTitleViewLargeMode=1;navigationBar;updateSelector(){this.selector={navigation:$(this.navigationBar.id+"-navigation"),largeTitleView:$(this.navigationBar.id+"-large-title"),smallTitleView:$(this.navigationBar.id+"-small-title"),underlineView:this.navigationBar.navigationBarItems.isPinTitleView?$(this.navigationBar.id+"-title-view-underline"):$(this.navigationBar.id+"-underline"),largeTitleMaskView:$(this.navigationBar.id+"-large-title-mask"),backgroundView:$(this.navigationBar.id+"-background"),titleViewBackgroundView:$(this.navigationBar.id+"-title-view-background")}}toNormal(t=!0){this.updateSelector(),this.selector.backgroundView.hidden=!1,$ui.animate({duration:.2,animation:()=>{this.selector.underlineView.alpha=1,this.selector.smallTitleView.alpha=1,this.selector.largeTitleView.alpha=0}}),t&&this.navigationBar.navigationBarItems&&(this.navigationBar.largeTitleDisplayMode=NavigationBar.largeTitleDisplayModeNever)}toLargeTitle(t=!0){this.updateSelector(),this.selector.backgroundView.hidden=!0,$ui.animate({duration:.2,animation:()=>{this.selector.underlineView.alpha=0,this.selector.smallTitleView.alpha=0,this.selector.largeTitleView.alpha=1}}),t&&this.navigationBar.navigationBarItems&&(this.navigationBar.largeTitleDisplayMode=NavigationBar.largeTitleDisplayModeAlways)}#t(t){let e=t===r.largeTitleViewSmallMode;this.selector.largeTitleView.alpha=e?0:1,$ui.animate({duration:.2,animation:()=>{this.selector.smallTitleView.alpha=e?1:0}})}#e(t){if(this.selector.largeTitleView.updateLayout((i,s)=>{this.navigationBar.navigationBarNormalHeight-t>0?i.top.equalTo(s.super.safeAreaTop).offset(this.navigationBar.navigationBarNormalHeight-t):i.top.equalTo(s.super.safeAreaTop).offset(0)}),t>0)t>=this.navigationBar.navigationBarNormalHeight?this.#t(r.largeTitleViewSmallMode):this.#t(r.largeTitleViewLargeMode);else{this.#t(r.largeTitleViewLargeMode);let i=this.navigationBar.largeTitleFontSize-t*.04;i>40&&(i=40),this.selector.largeTitleView.font=$font(this.navigationBar.fontFamily,i)}}#s(t){let e=this.navigationBar.largeTitleDisplayMode===NavigationBar.largeTitleDisplayModeNever?5:this.navigationBar.navigationBarNormalHeight,i=this.selector.titleViewBackgroundView!==void 0;if(t>e){this.selector.backgroundView.hidden=!1;let s=()=>{i&&this.navigationBar.navigationBarItems.isPinTitleView&&(this.selector.titleViewBackgroundView.alpha=1),this.selector.largeTitleMaskView.alpha=0,this.selector.underlineView.alpha=1};(t-e)/3>=1?s():$ui.animate({duration:.2,animation:()=>{s()}})}else this.selector.largeTitleMaskView.alpha=t>0?1:0,this.selector.underlineView.alpha=0,i&&(this.selector.titleViewBackgroundView.alpha=0),this.selector.backgroundView.hidden=!0}didScroll(t){if(!this.navigationBar.prefersLargeTitles)return;let e=this.navigationBar.largeTitleDisplayMode;if(e!==NavigationBar.largeTitleDisplayModeAlways)if(this.updateSelector(),e===NavigationBar.largeTitleDisplayModeAutomatic){if(!this.navigationBar.navigationBarItems?.isPinTitleView&&(this.navigationBar.navigationBarItems?.titleView?.controller.didScroll(t),t>0)){let i=this.navigationBar.navigationBarItems?.titleView?.height??0;t-=i,t<0&&(t=0)}this.#e(t),this.#s(t)}else e===NavigationBar.largeTitleDisplayModeNever&&this.#s(t)}didEndDragging(t,e,i,s){if(!this.navigationBar.prefersLargeTitles)return;let o=this.navigationBar.largeTitleDisplayMode;if(o!==NavigationBar.largeTitleDisplayModeAlways&&(this.updateSelector(),o===NavigationBar.largeTitleDisplayModeAutomatic)){let a=0;this.navigationBar.navigationBarItems?.isPinTitleView||(this.navigationBar.navigationBarItems?.titleView?.controller.didEndDragging(t,e,i,s),a=this.navigationBar.navigationBarItems?.titleView?.height??0,t-=a),t>=0&&t<=this.navigationBar.largeTitleFontHeight&&i($point(0,t>=this.navigationBar.largeTitleFontHeight/2?this.navigationBar.navigationBarNormalHeight+a-s:a-s))}}},NavigationViewTypeError=class extends ValidationError{constructor(t,e){super(t,e),this.name="NavigationViewTypeError"}},NavigationView=class extends Controller{page;navigationController=new NavigationBarController;navigationBar=new NavigationBar;navigationBarItems=new NavigationBarItems;constructor(){super(),this.navigationBar.navigationBarItems=this.navigationBarItems,this.navigationController.navigationBar=this.navigationBar}navigationBarTitle(t){return this.navigationBar.setTitle(t),this}setView(t){if(typeof t!="object")throw new NavigationViewTypeError("view","object");return this.view=View.create(t),this}#t(){if(!(this.view instanceof View))throw new NavigationViewTypeError("view","View");let t=this.view.scrollableView,e=$app.isDebugging||Kernel.isTaio?0:UIKit.topSafeAreaInsets,i=this.navigationBar.largeTitleDisplayMode===NavigationBar.largeTitleDisplayModeNever?this.navigationBar.navigationBarNormalHeight:this.navigationBar.navigationBarLargeTitleHeight,s=this.navigationBar.contentViewHeightOffset+i;if(this.navigationBarItems.titleView&&(s+=this.navigationBarItems.titleView.topOffset,s+=this.navigationBarItems.titleView.height,s+=this.navigationBarItems.titleView.bottomOffset),!this.view.scrollable||t.props.associateWithNavigationBar===!1){this.view.layout=(a,n)=>{a.left.right.equalTo(n.super.safeArea),a.bottom.equalTo(n.super);let l=s-this.navigationBar.contentViewHeightOffset;(!UIKit.isHorizontal||UIKit.isLargeScreen)&&this.navigationBar.topSafeArea&&(l+=e),a.top.equalTo(l)};return}t.props.stickyHeader&&(s-=i,s+=this.navigationBar.largeTitleFontHeight),t.props.header?t.props.header={type:"view",props:{height:s+(t.props.header?.props?.height??0)},views:[{type:"view",props:{clipsToBounds:!0},views:[t.props.header],layout:(a,n)=>{a.top.equalTo(s),a.bottom.width.equalTo(n.super)}}]}:t.props.header={props:{height:s}},t.props.footer=Object.assign({props:{}},t.props.footer??{}),t.props.footer.props.height=(this.navigationBarItems.fixedFooterView?.height??0)+(t.props.footer.props?.height??0);let o=this.navigationBarItems.isPinTitleView?this.navigationBarItems.titleView.height+this.navigationBarItems.titleView.bottomOffset+this.navigationBar.contentViewHeightOffset:0;if(t.props.indicatorInsets){let a=t.props.indicatorInsets;t.props.indicatorInsets=$insets(a.top+this.navigationBar.navigationBarNormalHeight+o,a.left,a.bottom+(this.navigationBarItems.fixedFooterView?.height??0),a.right)}else t.props.indicatorInsets=$insets(this.navigationBar.navigationBarNormalHeight+o,0,this.navigationBarItems.fixedFooterView?.height??0,0);t.layout=(a,n)=>{t.props.stickyHeader?a.top.equalTo(n.super.safeArea).offset(this.navigationBar.navigationBarNormalHeight):a.top.equalTo(n.super),a.left.right.equalTo(n.super.safeArea),a.bottom.equalTo(n.super)},t.assignEvent("didScroll",a=>{let n=a.contentOffset.y;(!UIKit.isHorizontal||UIKit.isLargeScreen)&&this.navigationBar.topSafeArea&&!t.props.stickyHeader&&(n+=e),this.navigationController.didScroll(n)}).assignEvent("didEndDragging",(a,n)=>{let l=a.contentOffset.y,h=0;(!UIKit.isHorizontal||UIKit.isLargeScreen)&&this.navigationBar.topSafeArea&&!t.props.stickyHeader&&(l+=e,h=e),this.navigationController.didEndDragging(l,n,(...u)=>a.scrollToOffset(...u),h)}).assignEvent("didEndDecelerating",(...a)=>{a[0].tracking||t.events?.didEndDragging(...a)})}#e(){if(this.navigationBar.prefersLargeTitles){this.#t();let t={};if(this.navigationBarItems.titleView){let e=this.navigationBar.largeTitleDisplayMode===NavigationBar.largeTitleDisplayModeNever?1:0;t=View.create({views:[this.navigationBar.backgroundColor?{type:"view",props:{alpha:e,bgcolor:this.navigationBar.backgroundColor,id:this.navigationBar.id+"-title-view-background"},layout:$layout.fill}:UIKit.blurBox({alpha:e,id:this.navigationBar.id+"-title-view-background"}),UIKit.separatorLine({id:this.navigationBar.id+"-title-view-underline",alpha:e}),this.navigationBarItems.titleView.definition],layout:(i,s)=>{i.top.equalTo(s.prev.bottom),i.width.equalTo(s.super),i.height.equalTo(this.navigationBarItems.titleView.topOffset+this.navigationBarItems.titleView.height+this.navigationBarItems.titleView.bottomOffset)}})}this.page=PageView.createFromViews([this.view,this.navigationBar.getLargeTitleView(),t,this.navigationBar.getNavigationBarView(),this.navigationBarItems.fixedFooterView?.definition??{}])}else this.page=PageView.createFromViews([this.view]);this.view.props?.bgcolor?this.page.setProp("bgcolor",this.view.props.bgcolor):this.page.setProp("bgcolor",UIKit.defaultBackgroundColor(this.view.type))}getPage(){return this.page||this.#e(),this.page}},SearchBar=class extends BarTitleView{height=35;topOffset=15;bottomOffset=10;horizontalOffset=15;kbType=$kbType.search;placeholder=$l10n("SEARCH");inputEvents={};keyboardView;accessoryView;cancelButtonFont=$font(16);constructor(t){super(t),this.setController(new SearchBarController),this.controller.setSearchBar(this)}get cancelButtonWidth(){return UIKit.getContentSize(this.cancelButtonFont,$l10n("CANCEL")).width}setEvent(t,e){return this.inputEvents[t]=e,this}setPlaceholder(t){return this.placeholder=t,this}setKbType(t){return this.kbType=t,this}setKeyboardView(t){return this.keyboardView=t,this}setAccessoryView(t){return this.accessoryView=t,this}onBeginEditingAnimate(){$ui.animate({duration:.3,animation:()=>{let t=this.cancelButtonWidth;$(this.id+"-cancel-button").updateLayout((e,i)=>{e.left.equalTo(i.super.right).offset(-t)}),$(this.id+"-cancel-button").alpha=1,$(this.id+"-cancel-button").relayout(),$(this.id+"-input").updateLayout(e=>{e.right.inset(t+this.horizontalOffset/2)}),$(this.id+"-input").relayout()}})}onEndEditingAnimate(){$ui.animate({duration:.3,animation:()=>{$(this.id+"-cancel-button").updateLayout((t,e)=>{t.left.equalTo(e.super.right)}),$(this.id+"-cancel-button").alpha=0,$(this.id+"-cancel-button").relayout(),$(this.id+"-input").updateLayout($layout.fill),$(this.id+"-input").relayout()}})}cancel(){$(this.id+"-input").blur(),$(this.id+"-input").text="",this.onEndEditingAnimate(),this.controller.callEvent("onCancel")}getView(){return this.props={id:this.id,smoothCorners:!0,cornerRadius:6},this.views=[{type:"input",props:{id:this.id+"-input",type:this.kbType,bgcolor:$color("#EEF1F1","#212121"),placeholder:this.placeholder,keyboardView:this.keyboardView,accessoryView:this.accessoryView},layout:$layout.fill,events:Object.assign({didBeginEditing:t=>{this.onBeginEditingAnimate(),this.controller.callEvent("onBeginEditing",t.text)},didEndEditing:t=>{this.controller.callEvent("onEndEditing",t.text)},changed:t=>this.controller.callEvent("onChange",t.text),returned:t=>this.controller.callEvent("onReturn",t.text)},this.inputEvents)},{type:"button",props:{id:this.id+"-cancel-button",title:$l10n("CANCEL"),font:this.cancelButtonFont,titleColor:$color("tintColor"),bgcolor:$color("clear"),alpha:0,hidden:!1},events:{tapped:()=>this.cancel()},layout:(t,e)=>{t.height.equalTo(e.super),t.width.equalTo(this.cancelButtonWidth),t.left.equalTo(e.super.right)}}],this.layout=(t,e)=>{t.height.equalTo(this.height),t.top.equalTo(e.super.safeArea).offset(this.topOffset),t.left.equalTo(e.super.safeArea).offset(this.horizontalOffset),t.right.equalTo(e.super.safeArea).offset(-this.horizontalOffset)},this}},SearchBarController=class extends Controller{setSearchBar(t){return this.searchBar=t,this}updateSelector(){this.selector={inputBox:$(this.searchBar.id),input:$(this.searchBar.id+"-input")}}hide(){this.updateSelector(),this.selector.inputBox.updateLayout(t=>{t.height.equalTo(0)})}show(){this.updateSelector(),this.selector.inputBox.updateLayout(t=>{t.height.equalTo(this.searchBar.height)})}didScroll(t){this.updateSelector();let e=this.searchBar.height-t;if(e=e>0?e>this.searchBar.height?this.searchBar.height:e:0,this.selector.inputBox.updateLayout(i=>{i.height.equalTo(e)}),t>0){let i=(this.searchBar.height/2-5-t)/10;this.selector.input.alpha=i}else this.selector.input.alpha=1}didEndDragging(t,e,i){this.updateSelector(),t>=0&&t<=this.searchBar.height&&i($point(0,t>=this.searchBar.height/2?this.searchBar.height:0))}},ViewController=class extends Controller{#t=[];#e(t){t.callEvent("onPop"),this.callEvent("onPop",t),this.#t.pop()}push(t){let e=this.#t[this.#t.length-1];t.navigationBarItems.addPopButton(e?.navigationBar.title),this.#t.push(t),$ui.push({props:{statusBarStyle:0,navBarHidden:!0},events:{dealloc:()=>{this.#e(t)}},views:[t.getPage().definition],layout:$layout.fill})}},SettingInfo=class extends SettingItem{getView(t){let e=Array.isArray(t),i=e?t[0]:t,s=e?t[1]:t;return{type:"view",props:{selectable:!0},views:[this.createLineLabel(),{type:"label",props:{text:i,align:$align.right,textColor:$color("darkGray")},layout:(o,a)=>{o.centerY.equalTo(a.prev),o.right.inset(SettingItem.edgeOffset),o.width.equalTo(180)}},{type:"view",events:{tapped:()=>{$ui.alert({title:this.title,message:s,actions:[{title:$l10n("COPY"),handler:()=>{$clipboard.text=s,$ui.toast($l10n("COPIED"))}},{title:$l10n("OK")}]})}},layout:(o,a)=>{o.right.inset(0),o.size.equalTo(a.super)}}],layout:$layout.fill}}},SettingSwitch=class extends SettingItem{getView(){return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"switch",props:{on:this.get(),onColor:$color("#00CC00")},events:{changed:t=>{try{this.set(t.on)}catch(e){throw t.on=!t.on,e}}},layout:(t,e)=>{t.centerY.equalTo(e.prev),t.right.inset(SettingItem.edgeOffset)}}],layout:$layout.fill}}},SettingString=class extends SettingItem{getView(){return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"button",props:{symbol:"square.and.pencil",bgcolor:$color("clear"),tintColor:$color("primaryText")},events:{tapped:t=>{let e=$ui.popover({sourceView:t,sourceRect:t.bounds,directions:$popoverDirection.down,size:$size(320,150),views:[{type:"text",props:{id:`${this.id}-string`,align:$align.left,text:this.get()},layout:i=>{i.left.right.inset(10),i.top.inset(20),i.height.equalTo(90)}},{type:"button",props:{symbol:"checkmark",bgcolor:$color("clear"),titleEdgeInsets:10,contentEdgeInsets:0},layout:i=>{i.right.inset(10),i.bottom.inset(25),i.size.equalTo(30)},events:{tapped:()=>{this.set($(`${this.id}-string`).text),e.dismiss()}}}]})}},layout:(t,e)=>{t.centerY.equalTo(e.prev),t.right.inset(0),t.size.equalTo(50)}}],layout:$layout.fill}}},SettingStepper=class extends SettingItem{getView(t,e){let i=`${this.id}-label`;return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"label",props:{id:i,text:this.get(),align:$align.left},layout:(s,o)=>{s.height.equalTo(o.super),s.right.inset(120)}},{type:"stepper",props:{min:t,max:e,value:this.get()},events:{changed:s=>{$(i).text=s.value;try{this.set(s.value)}catch(o){throw $(i).text=this.get(),o}}},layout:(s,o)=>{s.centerY.equalTo(o.prev),s.right.inset(SettingItem.edgeOffset)}}],layout:$layout.fill}}},SettingScript=class extends SettingItem{#withTouchEventT;#touchHighlightStart(){$(this.id).bgcolor=$color("systemFill")}#touchHighlightEnd(r=.3){r===0?$(this.id).bgcolor=$color("clear"):$ui.animate({duration:r,animation:()=>{$(this.id).bgcolor=$color("clear")}})}#withTouchEvent(r,t=!1,e=0){if(r=Object.assign(r,{touchesBegan:()=>{this.#touchHighlightStart(),this.#withTouchEventT=$delay(1,()=>this.#touchHighlightEnd(0))},touchesMoved:()=>{this.#withTouchEventT?.cancel(),this.#touchHighlightEnd(0)}}),t){let i=r.tapped;r.tapped=()=>{this.#touchHighlightStart(),$delay(e,()=>this.#touchHighlightEnd()),typeof i=="function"&&i()}}return r}getView(script){let buttonId=`${this.id}-button`,rightSymbol="chevron.right",start=()=>{$(buttonId).alpha=0,$(`${buttonId}-spinner`).alpha=1,this.#touchHighlightStart()},cancel=()=>{$(buttonId).alpha=1,$(`${buttonId}-spinner`).alpha=0,this.#touchHighlightEnd()},done=()=>{$(`${buttonId}-spinner`).alpha=0,this.#touchHighlightEnd();let r=$(buttonId);r.symbol="checkmark",$ui.animate({duration:.6,animation:()=>r.alpha=1,completion:()=>{$ui.animate({duration:.4,animation:()=>r.alpha=0,completion:()=>{r.symbol=rightSymbol,$ui.animate({duration:.4,animation:()=>r.alpha=1})}})}}),$delay(.6,()=>{})};return{type:"view",props:{id:this.id},views:[this.createLineLabel(),{type:"view",views:[{type:"button",props:{id:buttonId,symbol:rightSymbol,bgcolor:$color("clear"),tintColor:$color("secondaryText")},layout:(r,t)=>{r.centerY.equalTo(t.super),r.right.inset(0),r.height.equalTo(t.super)}},{type:"spinner",props:{id:`${buttonId}-spinner`,loading:!0,alpha:0},layout:(r,t)=>{r.size.equalTo(15),r.centerY.equalTo(t.super),r.right.equalTo(t.prev)}}],layout:(r,t)=>{r.right.inset(SettingItem.edgeOffset),r.height.equalTo(SettingItem.rowHeight),r.width.equalTo(t.super)}},{type:"view",layout:$layout.fill}],events:this.#withTouchEvent({tapped:()=>{let animate={start,cancel,done,touchHighlightStart:()=>this.#touchHighlightStart(),touchHighlightEnd:()=>this.#touchHighlightEnd()};typeof script=="function"?script(animate):script.startsWith("this.method")?eval(`(()=>{return ${script}(animate)})()`):eval(script)}}),layout:$layout.fill}}},SettingTab=class extends SettingItem{getView(t,e){t=this.evalValues(t),e=this.evalValues(e);let i=t?.length>0&&e?.length===t?.length;return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"tab",props:{items:t??[],index:i?e.indexOf(this.get()):this.get(),dynamicWidth:!0},layout:(s,o)=>{s.right.inset(SettingItem.edgeOffset),s.centerY.equalTo(o.prev)},events:{changed:s=>{i?this.set(e[s.index]):this.set(s.index)}}}],layout:$layout.fill}}},SettingMenu=class extends SettingItem{getView(t,e,i){let s=`${this.id}-label`,o=this.evalValues(t),a=this.evalValues(e),n=o?.length>0&&a?.length===o?.length,l=(u,c)=>{if(n){let g=this.evalValues(e);this.set(g[c])}else this.set(c);$(s).title=u},h=()=>{i||$ui.menu({items:this.evalValues(t),handler:l})};return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"view",views:[{type:"button",props:{menu:i?{pullDown:!0,asPrimary:!0,items:o.map((u,c)=>({title:u,handler:()=>l(u,c)}))}:void 0,title:n?o[a.indexOf(this.get())]:o[this.get()],titleColor:$color("secondaryText"),bgcolor:$color("clear"),id:s},events:{tapped:h},layout:(u,c)=>{u.right.inset(0),u.height.equalTo(c.super)}}],layout:(u,c)=>{u.right.inset(SettingItem.edgeOffset),u.height.equalTo(SettingItem.rowHeight),u.width.equalTo(c.super)}}],events:{tapped:h},layout:$layout.fill}}},SettingColor=class extends SettingItem{get(t=null){let e=super.get(t);return e?typeof e=="string"?$color(e):$rgba(e.red,e.green,e.blue,e.alpha):t}getView(){let t=`${this.id}-color`;return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"view",views:[{type:"view",props:{id:t,bgcolor:this.get(),circular:!0,borderWidth:1,borderColor:$color("#e3e3e3")},layout:(e,i)=>{e.centerY.equalTo(i.super),e.right.inset(SettingItem.edgeOffset),e.size.equalTo(20)}},{type:"view",events:{tapped:async()=>{let e=await $picker.color({color:this.get()});this.set(e.components),$(t).bgcolor=$rgba(e.components.red,e.components.green,e.components.blue,e.components.alpha)}},layout:(e,i)=>{e.right.inset(0),e.height.width.equalTo(i.super.height)}}],layout:(e,i)=>{e.height.equalTo(SettingItem.rowHeight),e.width.equalTo(i.super)}}],layout:$layout.fill}}},SettingDate=class extends SettingItem{getView(t=2){let e=i=>{let s="";switch(typeof i=="number"&&(i=new Date(i)),t){case 0:s=i.toLocaleTimeString();break;case 1:s=i.toLocaleDateString();break;case 2:s=i.toLocaleString();break}return s};return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"view",views:[{type:"label",props:{id:`${this.id}-label`,color:$color("secondaryText"),text:this.get()?e(this.get()):"None"},layout:(i,s)=>{i.right.inset(0),i.height.equalTo(s.super)}}],events:{tapped:async()=>{let i=this.get(),s=await $picker.date({props:{mode:t,date:i||Date.now()}});this.set(s.getTime()),$(`${this.id}-label`).text=e(s)}},layout:(i,s)=>{i.right.inset(SettingItem.edgeOffset),i.height.equalTo(SettingItem.rowHeight),i.width.equalTo(s.super)}}],layout:$layout.fill}}},SettingInput=class extends SettingItem{getView(t=!1,e=$kbType.default,i){i===void 0&&(i=o=>this.set(o));let s=this.id+"-input";return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"input",props:{id:s,type:e,align:$align.right,bgcolor:$color("clear"),textColor:$color("secondaryText"),text:this.get(),font:$font(16),secure:t,accessoryView:UIKit.blurBox({height:44},[UIKit.separatorLine({},UIKit.align.top),{type:"button",props:{title:$l10n("DONE"),bgcolor:$color("clear"),titleColor:$color("primaryText")},layout:(o,a)=>{o.right.inset(SettingItem.edgeOffset),o.centerY.equalTo(a.super)},events:{tapped:()=>{$(s).blur()}}},{type:"button",props:{title:$l10n("CANCEL"),bgcolor:$color("clear"),titleColor:$color("primaryText")},layout:(o,a)=>{o.left.inset(SettingItem.edgeOffset),o.centerY.equalTo(a.super)},events:{tapped:()=>{let o=$(s),a=this.get("");o.text!==a&&(o.text=a),o.blur()}}}])},layout:(o,a)=>{o.left.equalTo(a.prev.get("label").right).offset(SettingItem.edgeOffset),o.right.inset(SettingItem.edgeOffset);let n=UIKit.getContentSize($font(16),this.get("")).width;o.width.greaterThanOrEqualTo(n+30),o.height.equalTo(a.super)},events:{didBeginEditing:o=>{o.secure=!1,$app.autoKeyboardEnabled||($app.autoKeyboardEnabled=!0)},returned:o=>{o.blur()},didEndEditing:async o=>{let a=this.get("");i(o.text)||(o.text=a),t&&(o.secure=t)}}}],layout:$layout.fill}}},SettingNumber=class extends SettingItem{getView(){return SettingInput.from(this).getView(!1,$kbType.decimal,t=>t===""||!(i=>/^[0-9]+.?[0-9]*$/.test(i))(t)?($ui.toast($l10n("INVALID_VALUE")),!1):this.set(Number(t)))}},SettingIcon=class extends SettingItem{getView(t="#000000"){let e=`${this.id}-image`;return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"view",views:[{type:"image",props:{cornerRadius:8,bgcolor:typeof t=="string"?$color(t):t,smoothCorners:!0},layout:(i,s)=>{i.right.inset(SettingItem.edgeOffset),i.centerY.equalTo(s.super),i.size.equalTo($size(30,30))}},{type:"image",props:{id:e,image:$image(this.get()),icon:$icon(this.get()?.slice(5,this.get().indexOf(".")),$color("#ffffff")),tintColor:$color("#ffffff")},layout:(i,s)=>{i.right.equalTo(s.prev).offset(-5),i.centerY.equalTo(s.super),i.size.equalTo($size(20,20))}}],events:{tapped:()=>{$ui.menu({items:[$l10n("JSBOX_ICON"),$l10n("SF_SYMBOLS"),$l10n("IMAGE_BASE64")],handler:async(i,s)=>{if(s===0){let o=await $ui.selectIcon();this.set(o),$(e).icon=$icon(o.slice(5,o.indexOf(".")),$color("#ffffff"))}else(s===1||s===2)&&$input.text({text:"",placeholder:i,handler:o=>{if(o===""){$ui.toast($l10n("INVALID_VALUE"));return}this.set(o),s===1?$(e).symbol=o:$(e).image=$image(o)}})}})}},layout:(i,s)=>{i.right.inset(0),i.height.equalTo(SettingItem.rowHeight),i.width.equalTo(s.super)}}],layout:$layout.fill}}},SettingPush=class extends SettingItem{method=this.setting.method;getView(view,tapped){return{type:"view",layout:$layout.fill,props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"button",props:{symbol:"chevron.right",bgcolor:$color("clear"),tintColor:$color("secondaryText")},layout:(r,t)=>{r.centerY.equalTo(t.super),r.right.inset(SettingItem.edgeOffset),r.height.equalTo(t.super)}},{type:"view",layout:$layout.fill}],events:{tapped:()=>{let push=view=>{if(typeof view=="string"&&view.startsWith("this.method")?view=eval(`(()=>{return ${view}()})()`):typeof view=="function"&&(view=view()),this.setting.isUseJsboxNav)UIKit.push({title:this.title,props:view.props??{},views:[view]});else{let r=new NavigationView;r.setView(view).navigationBarTitle(this.title),r.navigationBarItems.addPopButton(),r.navigationBar.setLargeTitleDisplayMode(NavigationBar.largeTitleDisplayModeNever),this.setting.hasSectionTitle(view)&&r.navigationBar.setContentViewHeightOffset(-10),this.setting.viewController.push(r)}};typeof tapped=="function"?tapped(push):push(view)}}}}},SettingChild=class extends SettingItem{getView(t){return SettingPush.from(this).getView(void 0,e=>{this.setting.events?.onChildPush?this.setting.callEvent("onChildPush",this.setting.getListView(t,{}),this.title):e(this.setting.getListView(t,{}))})}},SettingImage=class extends SettingItem{getImagePath(t=!1){let e=$text.MD5(this.key)+".jpg";return t&&(e="compress."+e),this.setting.imagePath+e}getImage(t=!1){try{return this.setting.fileStorage.readSync(this.getImagePath(t))}catch(e){if(e instanceof FileStorageFileNotFoundError)return null;throw e}}get(t=null){return this.getImage(!1)??null}getView(){let t=`${this.id}-image`,e=$image("questionmark.square.dashed"),i=o=>async()=>{$(t).hidden=!0,$(`${t}-spinner`).hidden=!1,await $wait(.1);try{await o()}catch(a){$ui.alert({title:$l10n("ERROR"),message:String(a)})}await $wait(.1),$(`${t}-spinner`).hidden=!0,$(t).hidden=!1},s=[{title:$l10n("PREVIEW"),handler:i(()=>{let o=this.getImage(!1);o?Sheet.quickLookImage(o):$ui.toast($l10n("NO_IMAGE"))})},{inline:!0,items:[{title:$l10n("SELECT_IMAGE_PHOTO"),handler:i(async()=>{let o=await $photo.pick({format:"data"});if(!o.status||!o.data){if(o?.error?.description!=="canceled")throw new Error(o?.error?.description);return}let a=UIKit.compressImage(o.data.image);this.setting.fileStorage.write(this.getImagePath(!0),a.jpg(.8)),this.setting.fileStorage.write(this.getImagePath(),o.data),$(t).image=a,$ui.success($l10n("SUCCESS"))})},{title:$l10n("SELECT_IMAGE_ICLOUD"),handler:i(async()=>{let o=await $drive.open();if(!o)return;let a=UIKit.compressImage(o.image);this.setting.fileStorage.write(this.getImagePath(!0),a.jpg(.8)),this.setting.fileStorage.write(this.getImagePath(),o),$(t).image=a,$ui.success($l10n("SUCCESS"))})}]},{title:$l10n("CLEAR_IMAGE"),destructive:!0,handler:i(()=>{this.setting.fileStorage.delete(this.getImagePath(!0)),this.setting.fileStorage.delete(this.getImagePath()),$(t).image=e,$ui.success($l10n("SUCCESS"))})}];return{type:"view",props:{id:this.id,selectable:!0},views:[this.createLineLabel(),{type:"view",views:[{type:"image",props:{id:t,image:this.getImage(!0)?.image??e},layout:(o,a)=>{o.right.inset(SettingItem.edgeOffset),o.centerY.equalTo(a.super),o.size.equalTo($size(30,30))}},{type:"spinner",props:{id:`${t}-spinner`,loading:!0,hidden:!0},layout:(o,a)=>{o.size.equalTo(a.prev),o.left.top.equalTo(a.prev)}},{type:"button",props:{menu:{pullDown:!0,asPrimary:!0,items:s},bgcolor:$color("clear")},layout:(o,a)=>{o.right.inset(SettingItem.edgeOffset),o.centerY.equalTo(a.super),o.size.equalTo($size(30,30))}}],layout:(o,a)=>{o.right.inset(0),o.height.equalTo(SettingItem.rowHeight),o.width.equalTo(a.super)}}],layout:$layout.fill}}},Setting=class extends Controller{name;setting={};settingItems={};exclude=["script","info"];userData;fileStorage;imagePath;viewController=new ViewController;method={readme:()=>{let t=(()=>{let i=$device.info?.language?.startsWith("zh")?"README_CN.md":"README.md";try{return __README__[i]??__README__["README.md"]}catch{return $file.read(i)?.string??$file.read("README.md")?.string}})();new Sheet().setView({type:"markdown",props:{content:t},layout:(i,s)=>{i.size.equalTo(s.super)}}).init().present()}};#t=!1;#e=!1;#s;constructor(t={}){super(),typeof t.set=="function"&&typeof t.get=="function"?(this.set=t.set,this.getOriginal=t.get,this.userData=t.userData??{}):(this.fileStorage=t.fileStorage??new FileStorage,this.dataFile=t.dataFile??"setting.json"),t.structure?this.setStructure(t.structure):this.setStructurePath(t.structurePath??"setting.json"),this.isUseJsboxNav=t.isUseJsboxNav??!1,this.imagePath=(t.name??"default")+".image/",this.setName(t.name??$text.uuid)}useJsboxNav(){return this.isUseJsboxNav=!0,this}#i(){if(!this.#e)throw new SettingLoadConfigError}loader(t){if(this.settingItems[t.key])return this.settingItems[t.key];Array.isArray(t.items)&&(t.items=t.items.map(i=>$l10n(i))),t.title=$l10n(t.title),t.setting=this;let e=null;switch(t.type){case"info":e=SettingInfo.from(t).options(t.value);break;case"switch":e=SettingSwitch.from(t);break;case"string":e=SettingString.from(t);break;case"stepper":e=SettingStepper.from(t).options(t.min??1,t.max??12);break;case"script":e=SettingScript.from(t).options(t.value);break;case"tab":e=SettingTab.from(t).options(t.items,t.values);break;case"menu":e=SettingMenu.from(t).options(t.items,t.values,t.pullDown??!1);break;case"color":e=SettingColor.from(t);break;case"date":e=SettingDate.from(t).options(t.mode);break;case"input":e=SettingInput.from(t).options(t.secure);break;case"number":e=SettingNumber.from(t);break;case"icon":e=SettingIcon.from(t).options(t.bgcolor);break;case"push":e=SettingPush.from(t).options(t.view);break;case"child":e=SettingChild.from(t).options(t.children);break;case"image":e=SettingImage.from(t);break}return e}loadConfig(){let t=this.userData??this.fileStorage.readAsJSON(this.dataFile,{}),e=i=>{for(let s of i)for(let o of s.items)o.type==="child"?e(o.children):this.exclude.includes(o.type)||(this.setting[o.key]=o.key in t?t[o.key]:o.value,this.settingItems[o.key]=this.loader(o))};return e(this.structure),this.#e=!0,this}hasSectionTitle(t){return this.#i(),!!t[0]?.title}setUserData(t){return this.userData=t,this}setStructure(t){return this.structure=t,this}setStructurePath(t){return this.structure||this.setStructure(FileStorage.readFromRootAsJSON(t)),this}setName(t){return this.name=t,this}setFooter(t){return this.#s=t,this}set footer(t){this.#s=t}get footer(){if(this.#s===void 0){let t=FileStorage.readFromRootAsJSON("config.json",{}).info??{};if(!t.version||!t.author)try{t=__INFO__}catch{}this.#s={},t.version&&t.author&&(this.#s={type:"view",props:{height:70},views:[{type:"label",props:{font:$font(14),text:`${$l10n("VERSION")} ${t.version} \u2665 ${t.author}`,textColor:$color({light:"#C0C0C0",dark:"#545454"}),align:$align.center},layout:e=>{e.left.right.inset(0),e.top.inset(10)}}]})}return this.#s}setReadonly(){return this.#t=!0,this}set(t,e){if(this.#t)throw new SettingReadonlyError;return this.#i(),this.setting[t]=e,this.fileStorage.write(this.dataFile,$data({string:JSON.stringify(this.setting)})),this.callEvent("onSet",t,e),!0}getOriginal(t,e=null){return this.#i(),Object.prototype.hasOwnProperty.call(this.setting,t)?this.setting[t]:e}get(t,e=null){return this.#i(),this.settingItems[t]?this.settingItems[t].get(e):this.getOriginal(t,e)}#r(t){let e=[];for(let i of t){let s=[];for(let o of i.items){let a=this.loader(o)?.create();a&&s.push(a)}e.push({title:$l10n(i.title??""),rows:s})}return e}getListView(t=this.structure,e=this.footer){return{type:"list",props:{id:this.name,style:2,separatorInset:$insets(0,SettingItem.iconSize+SettingItem.edgeOffset*2,0,SettingItem.edgeOffset),footer:e,data:this.#r(t)},layout:$layout.fill,events:{rowHeight:(i,s)=>(i.object(s)?.props?.info??{}).rowHeight??SettingItem.rowHeight}}}getNavigationView(){let t=new NavigationView;return t.setView(this.getListView(this.structure)).navigationBarTitle($l10n("SETTING")),this.hasSectionTitle(this.structure)&&t.navigationBar.setContentViewHeightOffset(-10),t}getPage(){return this.getNavigationView().getPage()}},SheetViewTypeError=class extends ValidationError{constructor(t,e){super(t,e),this.name="SheetViewTypeError"}},TabBarCellView=class extends View{constructor(t={}){super(t),this.setIcon(t.icon),this.setTitle(t.title),t.activeStatus!==void 0&&(this.activeStatus=t.activeStatus)}setIcon(t){return t instanceof Array?this.icon=t:this.icon=[t,t],this}setTitle(t){return this.title=t,this}active(){$(`${this.props.id}-icon`).image=$image(this.icon[1]),$(`${this.props.id}-icon`).tintColor=$color("systemLink"),$(`${this.props.id}-title`).textColor=$color("systemLink"),this.activeStatus=!0}inactive(){$(`${this.props.id}-icon`).image=$image(this.icon[0]),$(`${this.props.id}-icon`).tintColor=$color("lightGray"),$(`${this.props.id}-title`).textColor=$color("lightGray"),this.activeStatus=!1}getView(){return this.views=[{type:"image",props:{id:`${this.props.id}-icon`,image:$image(this.activeStatus?this.icon[1]:this.icon[0]),bgcolor:$color("clear"),tintColor:$color(this.activeStatus?"systemLink":"lightGray")},layout:(t,e)=>{t.centerX.equalTo(e.super);let i=TabBarController.tabBarHeight/2;t.size.equalTo(i),t.top.inset((TabBarController.tabBarHeight-i-13)/2)}},{type:"label",props:{id:`${this.props.id}-title`,text:this.title,font:$font(10),textColor:$color(this.activeStatus?"systemLink":"lightGray")},layout:(t,e)=>{t.centerX.equalTo(e.prev),t.top.equalTo(e.prev.bottom).offset(3)}}],this}},TabBarHeaderView=class extends View{height=60;getView(){return this.type="view",this.setProp("bgcolor",this.props.bgcolor??UIKit.primaryViewBackgroundColor),this.layout=(t,e)=>{t.left.right.bottom.equalTo(e.super),t.top.equalTo(e.super.safeAreaBottom).offset(-this.height-TabBarController.tabBarHeight)},this.views=[View.create({props:this.props,views:this.views,layout:(t,e)=>{t.left.right.top.equalTo(e.super),t.height.equalTo(this.height)}})],this}},TabBarController=class r extends Controller{static tabBarHeight=50;#t={};#e={};#s;#i;#r=$text.uuid;#o=$text.uuid;bottomSafeAreaInsets=$app.isDebugging?0:UIKit.bottomSafeAreaInsets;get selected(){return this.#i}set selected(t){this.switchPageTo(t)}get contentOffset(){return r.tabBarHeight+(this.#s?.height??0)}setPages(t={}){return Object.keys(t).forEach(e=>this.setPage(e,t[e])),this}setPage(t,e){return this.#i===void 0&&(this.#i=t),e instanceof PageView?this.#t[t]=e:this.#t[t]=PageView.create(e),this.#i!==t&&(this.#t[t].activeStatus=!1),this}switchPageTo(t){if(this.#t[t]){if(this.#i===t)return;$ui.animate({duration:.4,animation:()=>{this.#e[t].active()}}),this.#e[this.#i].inactive(),this.#t[this.#i].hide(),this.#t[t].show(),this.callEvent("onChange",this.#i,t),this.#i=t,this.initBackground()}}hideBackground(t=!0){$(this.#o).hidden=!0,$ui.animate({duration:t?.2:1e-4,animation:()=>{$(this.#r).alpha=0}})}showBackground(t=!0){$(this.#o).hidden=!1,$ui.animate({duration:t?.2:1e-4,animation:()=>{$(this.#r).alpha=1}})}initBackground(){let t=this.#t[this.selected];t.scrollable&&$delay(0,()=>{let e=$(t.id).get(t.scrollableView.id),i=e.contentOffset.y;e.contentSize.height+this.bottomSafeAreaInsets-e.frame.height-i<=0?this.hideBackground(!1):this.showBackground(!1)})}setCells(t={}){return Object.keys(t).forEach(e=>this.setCell(e,t[e])),this}setCell(t,e){return this.#i===void 0&&(this.#i=t),e instanceof TabBarCellView||(e=new TabBarCellView({props:{info:{key:t}},icon:e.icon,title:e.title,activeStatus:this.#i===t})),this.#e[t]=e,this}setHeader(t){return this.#s=t,this}#a(){let t=[];return Object.values(this.#e).forEach(e=>{e.setEvent("tapped",i=>{let s=i.info.key;this.switchPageTo(s)}),t.push(e.getView())}),t}#n(){return Object.values(this.#t).map(t=>{if(t.scrollable){let e=t.scrollableView;if(e.props.indicatorInsets){let i=e.props.indicatorInsets;e.props.indicatorInsets=$insets(i.top,i.left,i.bottom+this.contentOffset,i.right)}else e.props.indicatorInsets=$insets(0,0,this.contentOffset,0);e.props.footer=Object.assign({props:{}},e.props.footer??{}),e.props.footer.props.height?e.props.footer.props.height+=this.contentOffset:e.props.footer.props.height=this.contentOffset,typeof e.assignEvent=="function"&&e.assignEvent("didScroll",i=>{let s=i.contentOffset.y;i.contentSize.height+this.bottomSafeAreaInsets-i.frame.height-s<=1?this.hideBackground():this.showBackground()})}return t.definition})}generateView(){let t={type:"view",layout:(e,i)=>{e.centerX.equalTo(i.super),e.width.equalTo(i.super),e.top.equalTo(i.super.safeAreaBottom).offset(-r.tabBarHeight),e.bottom.equalTo(i.super)},views:[UIKit.blurBox({id:this.#r}),{type:"stack",layout:$layout.fillSafeArea,props:{axis:$stackViewAxis.horizontal,distribution:$stackViewDistribution.fillEqually,spacing:0,stack:{views:this.#a()}}},UIKit.separatorLine({id:this.#o},UIKit.align.top)],events:{ready:()=>this.initBackground()}};return View.createFromViews(this.#n().concat(this.#s?.definition??[],t))}},PageView=class extends View{constructor(t={}){super(t),this.activeStatus=!0}show(){$(this.props.id).hidden=!1,this.activeStatus=!0}hide(){$(this.props.id).hidden=!0,this.activeStatus=!1}setHorizontalSafeArea(t){return this.horizontalSafeArea=t,this}#t(t,e){t.top.bottom.equalTo(e.super),this.horizontalSafeArea?t.left.right.equalTo(e.super.safeArea):t.left.right.equalTo(e.super)}getView(){return this.layout=this.#t,this.props.clipsToBounds=!0,this.props.hidden=!this.activeStatus,super.getView()}},WebDAV=class extends Request{#t;user;password;#e;namespace="JSBox.WebDAV";lockTokenCacheKey=this.namespace+".lockToken";get host(){return this.#t}set host(t){for(this.#t=t.trim();this.#t.endsWith("/");)this.#t=this.#t.substring(0,this.#t.length-1);this.#t.startsWith("http")||(this.#t="http://"+this.#t)}get basepath(){return this.#e}set basepath(t){for(this.#e=t.trim();this.#e.endsWith("/");)this.#e=this.#e.substring(0,this.#e.length-1);for(;this.#e.startsWith("/");)this.#e=this.#e.substring(1);this.#e="/"+this.#e}constructor({host:t,user:e,password:i,basepath:s=""}={}){super(o=>console.log(o)),this.host=t,this.user=e,this.password=i,this.basepath=s}#s(t){return t=t.trim(),t=t.startsWith("/")?t:"/"+t,this.basepath+t}async request(t,e,i=null,s={}){return s=Object.assign({"Content-Type":"text/xml; charset=UTF-8",Authorization:"Basic "+$text.base64Encode(`${this.user}:${this.password}`)},s),await super.request(this.host+this.#s(t),e,i,s)}async allow(t){let e=await this.request(t,Request.method.options);return(e.response.headers?.allow??e.response.headers?.Allow)?.split(",").map(s=>s.trim().toUpperCase())??[]}async propfind(t,e=[],i=0){Array.isArray(e)||(e=[e]);let o=`<?xml version="1.0" encoding="utf-8" ?><D:propfind xmlns:D="DAV:"><D:prop>${e.map(n=>`<D:${n}/>`).join()}</D:prop></D:propfind>`,a=await this.request(t,"PROPFIND",o,{Depth:i});return $xml.parse({string:a.data})}async propfindAll(t,e=0){let i='<?xml version="1.0" encoding="utf-8" ?><D:propfind xmlns:D="DAV:"><D:allprop/></D:propfind>',s=await this.request(t,"PROPFIND",i,{Depth:e});return $xml.parse({string:s.data})}async ls(t,e=1){let i=await this.request(t,"PROPFIND",null,{Depth:e});return $xml.parse({string:i.data})}async exists(t){try{return(await this.allow(t)).includes(Request.method.get)?await this.request(t,Request.method.head):await this.ls(t,0),!0}catch(e){if(e?.code===404)return!1;throw e}}async mkdir(t){return await this.request(t,"MKCOL")}async get(t){return await this.request(t,Request.method.get,null)}async put(t,e,{withLock:i=!0,waitInterval:s=2,maxTry:o=3}={}){let a={};for(;await this.isLocked(t);){if(--o<=0)throw new Error("Resource Locked");await $wait(s)}if(i)try{await this.lock(t),a.If=`(${this.#r(t)})`}catch(n){if(n.code!==404)throw n;i=!1}await this.request(t,Request.method.put,e,a),i&&await this.unlock(t)}async delete(t){if(!t)throw new Error("path empty");return await this.request(t,Request.method.delete)}#i(t,e){let i=$cache.get(this.lockTokenCacheKey)??{};i[t]=e,$cache.set(this.lockTokenCacheKey,i)}#r(t){return($cache.get(this.lockTokenCacheKey)??{})[t]}async isSupportLock(t){try{return!!(await this.propfind(t,"supportedlock")).rootElement.firstChild({xPath:"//D:response/D:propstat/D:prop/D:supportedlock/D:lockentry"}).firstChild({xPath:"//D:locktype/D:write"})}catch(e){if(e.code!==404)return!1;throw e}}async lock(t,{infinity:e=!1,timeout:i="Second-10"}={}){if(!await this.isSupportLock(t))throw new Error("Your WebDAV service does not support the `LOCK` method.");let o=`<?xml version="1.0" encoding="utf-8" ?><D:lockinfo xmlns:D='DAV:'><D:lockscope><D:exclusive/></D:lockscope><D:locktype><D:write/></D:locktype><D:owner><D:href>${this.namespace}</D:href></D:owner></D:lockinfo>`,a=await this.request(t,"LOCK",o,{Timeout:i,Depth:e?"infinity":0}),n=a.response.headers["lock-token"]??a.response.headers["Lock-Token"];return this.#i(t,n),$xml.parse({string:a.data})}async isLocked(t){try{let i=(await this.propfind(t,"lockdiscovery")).rootElement;if(!i.firstChild({xPath:"//D:response/D:propstat/D:status"}).string.includes("404")){let n=i.firstChild({xPath:"//D:response/D:propstat/D:prop/D:lockdiscovery"}).children()??[];for(let l=0;l<n.length;l++)if(n[l].firstChild({tag:"lockroot"}).string===this.host+this.#s(t))return!0}else await this.lock(t,{timeout:"Second-0"})}catch(e){if(e.code===423)return!0}return!1}async refreshLock(t,{infinity:e=!1,timeout:i="Second-10"}={}){let s=await this.request(t,"LOCK",null,{Timeout:i,If:this.#r(t),Depth:e?"infinity":0});return $xml.parse({string:s.data})}async unlock(t){await this.request(t,"UNLOCK",null,{"Lock-Token":this.#r(t)})}};module.exports={AlertAction,Alert,Controller,FileManager,FileStorageParameterError,FileStorageFileNotFoundError,FileStorage,FixedFooterView,Kernel,L10n,Logger,Matrix,BarTitleView,BarButtonItem,NavigationBarItems,NavigationBar,NavigationBarController,NavigationViewTypeError,NavigationView,SearchBar,SearchBarController,ViewController,Plist,RequestError,Request,SettingItem,SettingInfo,SettingSwitch,SettingString,SettingStepper,SettingScript,SettingTab,SettingMenu,SettingColor,SettingDate,SettingInput,SettingNumber,SettingIcon,SettingPush,SettingChild,SettingImage,SettingLoadConfigError,SettingReadonlyError,Setting,SheetViewUndefinedError,SheetViewTypeError,Sheet,TabBarCellView,TabBarHeaderView,TabBarController,Tasks,Toast,UIKit,UILoading,ValidationError,View,PageView,WebDAV};
